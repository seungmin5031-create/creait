<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>크리에잇 - 프로젝트 관리 플랫폼111</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .nav-item.active { background-color: rgba(99, 102, 241, 0.1); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.2); }
        body.theme-light { background-color: #f1f5f9; color: #0f172a; }
        body.theme-light #main-app { background-color: #f1f5f9; }
        body.theme-light aside { background-color: #f8fafc; border-color: #e2e8f0; }
        body.theme-light .glass-panel { background: #ffffff; border-color: #e5e7eb; box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04); }
        body.theme-light .task-card,
        body.theme-light .contact-card { background-color: #ffffff; border-color: #e5e7eb; }
        body.theme-light .task-card:hover,
        body.theme-light .contact-card:hover { background-color: #f8fafc; }
        body.theme-light .nav-item { color: #475569; }
        body.theme-light .nav-item.active { background-color: #e2e8f0; color: #0f172a; border-color: #cbd5f5; }
        body.theme-light .main-header { background-color: #ffffff; border-color: #e2e8f0; }
        body.theme-light .main-views { background: #f1f5f9; }
        body.theme-light #searchInput { background-color: #f8fafc; border-color: #e2e8f0; color: #0f172a; }
        body.theme-light #searchInput::placeholder { color: #94a3b8; }
        body.theme-light .settings-button { background-color: #ffffff; border-color: #e2e8f0; color: #475569; }
        body.theme-light .settings-button:hover { background-color: #f1f5f9; }
        body.theme-light #taskDetailModal > div,
        body.theme-light #contactModal > div,
        body.theme-light #projectModal > div,
        body.theme-light #settingsModal > div,
        body.theme-light #profileModal > div { background-color: #ffffff; border-color: #e2e8f0; color: #0f172a; }
        body.theme-light input,
        body.theme-light select,
        body.theme-light textarea { background-color: #f8fafc; border-color: #e2e8f0; color: #0f172a; }
        body.theme-light #toast { background-color: #ffffff; border-color: #e2e8f0; color: #0f172a; }
        body.theme-light .calendar-grid { background-color: #e5e7eb; }
        body.theme-light .calendar-day { background-color: #ffffff; }
        body.theme-light .column-drop-zone.drag-over { background-color: rgba(59, 130, 246, 0.08); border-color: #93c5fd; }
        body.theme-light .markdown-body { color: #0f172a; }
        body.theme-light .markdown-body h1, body.theme-light .markdown-body h2 { color: #0f172a; border-color: #e2e8f0; }
        body.theme-light .markdown-body strong { color: #2563eb; }
        body.theme-light .bg-[#0f172a] { background-color: #f1f5f9; }
        body.theme-light .border-gray-700 { border-color: #e2e8f0; }
        body.theme-light .text-gray-100 { color: #0f172a; }
        body.theme-light .text-gray-200 { color: #111827; }
        body.theme-light .text-gray-300 { color: #1f2937; }
        body.theme-light .text-gray-400 { color: #475569; }
        body.theme-light .text-gray-500 { color: #64748b; }
        body.theme-light .hold-panel { background-color: #f8fafc; border-color: #e2e8f0; }
        body.theme-light .hold-room::before { background: rgba(148, 163, 184, 0.4); box-shadow: 0 0 0 1px rgba(226, 232, 240, 0.8); }
        body.theme-light .kanban-divider { background: rgba(203, 213, 225, 0.8); }
        .task-card { transition: all 0.2s ease; cursor: pointer; background-color: #1e293b; border: 1px solid #334155; }
        .task-card:hover { background-color: #334155; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .task-card.dragging { opacity: 0.5; transform: scale(0.98); }
        .column-drop-zone { min-height: 120px; }
        .column-drop-zone.drag-over { background-color: rgba(99, 102, 241, 0.1); border: 2px dashed #6366f1; border-radius: 0.5rem; }
        .column-drop-zone.drop-flash { animation: dropFlash 0.35s ease-out; }
        .hold-room { position: relative; padding-left: 18px; margin-left: 6px; }
        .hold-room::before { content: ""; position: absolute; left: 0; top: 10px; bottom: 10px; width: 1px; background: rgba(148, 163, 184, 0.25); box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6); }
        .hold-panel { background-color: rgba(15, 23, 42, 0.6); border: 1px solid rgba(51, 65, 85, 0.7); }
        .kanban-divider { width: 3px; background: rgba(148, 163, 184, 0.25); align-self: stretch; border-radius: 999px; }
        .task-desc-area { min-height: 220px; }
        .task-tab { padding: 4px 10px; font-size: 12px; font-weight: 700; border-radius: 999px; border: 1px solid #334155; color: #94a3b8; }
        .task-tab.active { background-color: rgba(99, 102, 241, 0.15); color: #c7d2fe; border-color: rgba(99, 102, 241, 0.3); }
        .date-toggle { display: inline-flex; align-items: center; gap: 10px; font-size: 11px; color: #94a3b8; letter-spacing: 0.02em; }
        .date-toggle input { display: none; }
        .date-toggle__track { width: 36px; height: 20px; border-radius: 999px; border: 1px solid #334155; background: #0f172a; position: relative; transition: all 0.2s ease; }
        .date-toggle__thumb { width: 14px; height: 14px; border-radius: 999px; background: #94a3b8; position: absolute; top: 2px; left: 2px; transition: all 0.2s ease; }
        .date-toggle input:checked + .date-toggle__track { background: rgba(99, 102, 241, 0.25); border-color: #6366f1; }
        .date-toggle input:checked + .date-toggle__track .date-toggle__thumb { transform: translateX(16px); background: #c7d2fe; }
        body.theme-light .date-toggle__track { background: #e2e8f0; border-color: #cbd5f5; }
        body.theme-light .date-toggle__thumb { background: #64748b; }
        body.theme-light .date-toggle input:checked + .date-toggle__track { background: #dbeafe; border-color: #3b82f6; }
        body.theme-light .date-toggle input:checked + .date-toggle__track .date-toggle__thumb { background: #1d4ed8; }
        #taskDetailModal .task-detail-main { background-color: #1e293b; }
        #taskDetailModal .task-tabs { gap: 8px; }
        #taskDetailModal .section-block { background: rgba(15, 23, 42, 0.35); border: 1px solid #334155; border-radius: 12px; padding: 16px; }
        #taskDetailModal .task-detail-side { background: rgba(15, 23, 42, 0.5); }
        .online-indicator { width: 10px; height: 10px; border-radius: 999px; background: #22c55e; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6); animation: pulseOnline 1.6s ease-in-out infinite; }
        @keyframes pulseOnline { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6); opacity: 1; } 70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); opacity: 1; } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); opacity: 0.9; } }
        @keyframes dropFlash { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.6); } 100% { box-shadow: 0 0 0 12px rgba(99, 102, 241, 0); } }
        .contact-card { background-color: #1e293b; border: 1px solid #334155; transition: all 0.2s ease; }
        .contact-card:hover { border-color: #6366f1; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(6, 1fr); gap: 1px; background-color: #334155; height: 100%; }
        .calendar-day { background-color: #1e293b; padding: 4px; display: flex; flex-direction: column; overflow: hidden; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .ai-loading::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .markdown-body { font-size: 0.95rem; line-height: 1.6; color: #e2e8f0; }
        .markdown-body h1, .markdown-body h2 { font-weight: 700; margin-top: 1em; color: #fff; border-bottom: 1px solid #334155; padding-bottom: 0.3em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body strong { color: #818cf8; }
        .custom-checkbox input:checked + div { background-color: #6366f1; border-color: #6366f1; }
        .custom-checkbox input:checked + div svg { display: block; }
        .status-radio:checked + label { background-color: #4f46e5; border-color: #6366f1; color: white; box-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }
        .filter-tab.active { background-color: #4f46e5; color: white; border-color: #6366f1; }
        .login-bg { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#0f172a] text-gray-200">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="fixed inset-0 z-50 flex items-center justify-center login-bg">
        <div class="w-full max-w-md p-8 bg-[#1e293b]/80 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl animate-slide-in">
            <div class="text-center mb-8">
                <h1 id="login-brand-name" class="text-4xl font-bold text-indigo-500 mb-2">크리에잇</h1>
                <p class="text-gray-400 text-sm">Creative Project Management</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6" novalidate>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">아이디</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-4 top-3.5 text-gray-500"></i>
                        <input type="text" class="w-full bg-[#0f172a] border border-gray-600 rounded-xl py-3 pl-11 pr-4 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-gray-600" placeholder="아이디를 입력하세요">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">비밀번호11</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-500"></i>
                        <input type="password" class="w-full bg-[#0f172a] border border-gray-600 rounded-xl py-3 pl-11 pr-4 text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-gray-600" placeholder="••••••••">
                    </div>
                </div>

                <div class="flex items-center justify-between text-xs text-gray-500">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="rounded bg-[#0f172a] border-gray-600 text-indigo-600 focus:ring-0">
                        로그인 상태 유지
                    </label>
                    <a href="#" class="hover:text-indigo-400 transition-colors">비밀번호 찾기</a>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all transform hover:scale-[1.02]">
                    로그인
                </button>
            </form>
            
            <div class="mt-8 text-center text-xs text-gray-600">
                &copy; 2025 creait. All rights reserved.
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="flex h-screen overflow-hidden hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#1e293b] border-r border-gray-700 flex-shrink-0 hidden md:flex flex-col z-20">
            <div class="h-16 flex items-center px-6 border-b border-gray-700"><div class="flex items-center gap-2 text-indigo-400 font-bold text-2xl"><span id="brand-name">크리에잇</span></div></div>
            <nav class="flex-1 overflow-y-auto py-4">
                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase mb-2 px-2">워크스페이스</p>
                    <button onclick="switchView('overview')" id="nav-overview" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 rounded-lg mb-1 font-medium transition-colors text-left"><i class="fa-solid fa-chart-simple w-5"></i> 모니터링</button>
                    <button onclick="switchView('projects')" id="nav-projects" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 rounded-lg mb-1 font-medium transition-colors text-left"><i class="fa-solid fa-folder-open w-5"></i> 전체 프로젝트</button>
                    <button onclick="switchView('board')" id="nav-board" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 rounded-lg mb-1 font-medium transition-colors text-left"><i class="fa-solid fa-table-columns w-5"></i> 대시보드·작업</button>
                    <button onclick="switchView('contacts')" id="nav-contacts" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 rounded-lg mb-1 font-medium transition-colors text-left"><i class="fa-solid fa-user-group w-5"></i> 인물</button>
                </div>
                <div class="px-4"><div class="flex items-center justify-between px-2 mb-2"><p class="text-xs font-semibold text-gray-500 uppercase">바로가기</p><button onclick="openProjectModal('create')" class="text-gray-500 hover:text-indigo-400 transition-colors"><i class="fa-solid fa-plus text-xs"></i></button></div><div id="project-list" class="space-y-1"></div></div>
            </nav>
            <div class="p-4 border-t border-gray-700 bg-[#1e293b]">
                 <!-- New Project Button -->
                <button onclick="openProjectModal('create')" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl text-sm font-bold shadow-lg transition-all hover:scale-[1.02] flex items-center justify-center gap-2 mb-3 group">
                    <div class="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors"><i class="fa-solid fa-plus text-[10px]"></i></div>새 프로젝트
                </button>
                <button onclick="openSettingsModal()" class="settings-button w-full bg-[#0f172a] hover:bg-[#111827] text-gray-300 py-2.5 rounded-xl text-sm font-medium border border-gray-700 transition-colors mb-4 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-gear text-xs"></i> 설정
                </button>
                <div id="profile-card" class="flex items-center justify-between gap-3 p-2 rounded-lg hover:bg-gray-700/50 cursor-pointer transition-colors group relative" onclick="toggleProfileMenu()">
                    <div class="flex items-center gap-3">
                        <div class="relative w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-300 font-bold border border-indigo-500/30 text-xs">
                            PD
                            <span class="absolute -right-1 -bottom-1 online-indicator" aria-label="온라인 상태"></span>
                        </div>
                        <div><p class="text-sm font-medium text-gray-200">변PD</p><p class="text-xs text-gray-500">Product Director</p></div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleProfileMenu()" class="text-gray-500 hover:text-gray-300 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="메뉴"><i class="fa-solid fa-ellipsis"></i></button>
                    <div id="profile-menu" class="hidden absolute right-0 bottom-12 w-44 bg-[#1e293b] border border-gray-700 rounded-lg shadow-lg p-2 z-50">
                        <button onclick="event.stopPropagation(); openAccountModal()" class="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-white/5 rounded">계정 관리</button>
                        <button onclick="handleLogout()" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-white/5 rounded">로그아웃</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-[#0f172a]">
            <!-- Header -->
            <header class="main-header h-16 bg-[#1e293b] border-b border-gray-700 flex items-center justify-between px-4 sm:px-8 flex-shrink-0 z-10">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-gray-400 hover:text-gray-200"><i class="fa-solid fa-bars text-xl"></i></button>
                    <div><div class="flex items-baseline gap-2"><h1 id="header-project-title" class="text-xl font-bold text-gray-100">프로젝트 선택</h1><span id="header-client-company" class="text-sm text-gray-500 font-medium"></span></div><div id="header-project-meta" class="flex items-center gap-2 mt-0.5"></div></div>
                </div>
                <div class="flex items-center gap-3 sm:gap-6">
                     <div class="hidden md:block relative group"><i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm group-hover:text-indigo-400 transition-colors"></i><input type="text" id="searchInput" placeholder="검색..." oninput="handleSearch()" class="pl-9 pr-4 py-1.5 bg-[#0f172a] border border-gray-700 rounded-full text-sm text-gray-200 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 w-48 transition-all placeholder-gray-600"></div>
                    <div class="flex -space-x-2 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-indigo-500/20 border-2 border-[#1e293b] flex items-center justify-center text-xs text-indigo-300 font-bold" title="김기획">김</div>
                        <div class="w-8 h-8 rounded-full bg-rose-500/20 border-2 border-[#1e293b] flex items-center justify-center text-xs text-rose-300 font-bold" title="이디자인">이</div>
                        <button class="w-8 h-8 rounded-full bg-gray-700 border-2 border-[#1e293b] flex items-center justify-center text-gray-400 hover:bg-gray-600 hover:text-gray-200 text-xs transition-colors"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <button onclick="openTaskModal('create')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-[0_0_15px_rgba(99,102,241,0.3)] hover:shadow-[0_0_20px_rgba(99,102,241,0.5)] flex items-center gap-2"><i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">새 업무</span></button>
                </div>
            </header>

            <!-- Views Container -->
            <div class="main-views flex-1 overflow-hidden relative bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black">

                <!-- VIEW: OVERVIEW -->
                <div id="view-overview" class="h-full overflow-y-auto p-4 sm:p-8 hidden animate-slide-in">
                    <div class="glass-panel p-6 rounded-xl border border-gray-700/50 mb-6">
                        <div class="flex items-start justify-between gap-4 mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-100">모니터링</h2>
                                <p class="text-xs text-gray-500 mt-1">전체 프로젝트 상태를 한눈에 확인하세요.</p>
                            </div>
                            <div class="text-xs text-gray-500">업데이트: <span id="overview-last-updated">-</span></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-[#0f172a]/60 border border-gray-700/60 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm text-gray-400">총 진행률</p>
                                    <span id="overview-progress-percent" class="text-lg font-bold text-indigo-300">0%</span>
                                </div>
                                <div class="h-2 bg-gray-800 rounded-full overflow-hidden mt-3">
                                    <div id="overview-progress-bar" class="h-full bg-indigo-500 transition-all" style="width: 0%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">완료 <span id="overview-done-count">0</span> / 전체 <span id="overview-task-count">0</span></div>
                            </div>
                            <div class="bg-[#0f172a]/60 border border-gray-700/60 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-2">총 예상 매출</p>
                                <h3 id="overview-total-revenue" class="text-2xl font-bold text-white">₩0.00만</h3>
                                <p class="text-xs text-gray-500 mt-2">프로젝트 목표 매출 합계</p>
                            </div>
                            <div class="bg-[#0f172a]/60 border border-gray-700/60 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-2">진행 매출</p>
                                <h3 id="overview-progress-revenue" class="text-2xl font-bold text-emerald-300">₩0.00만</h3>
                                <p class="text-xs text-gray-500 mt-2">진행률 기준 예상 매출</p>
                            </div>
                            <div class="bg-[#0f172a]/60 border border-gray-700/60 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-2">프로젝트 수</p>
                                <h3 id="overview-project-count" class="text-2xl font-bold text-white">0개</h3>
                                <p class="text-xs text-gray-500 mt-2">진행 중 <span id="overview-active-projects">0</span>개</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <div class="glass-panel p-6 rounded-xl xl:col-span-2 flex flex-col">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-200"><i class="fa-regular fa-calendar mr-2"></i>전체 프로젝트 캘린더</h3>
                                <div class="flex items-center gap-2 bg-[#0f172a] rounded-lg p-1 border border-gray-700">
                                    <button onclick="changeOverviewMonth(-1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                    <span id="overview-calendar-month" class="text-sm text-gray-300 font-medium w-24 text-center"></span>
                                    <button onclick="changeOverviewMonth(1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-hidden flex flex-col">
                                <div class="grid grid-cols-7 text-center mb-2">
                                    <div class="text-xs text-red-400">일</div><div class="text-xs text-gray-400">월</div><div class="text-xs text-gray-400">화</div><div class="text-xs text-gray-400">수</div><div class="text-xs text-gray-400">목</div><div class="text-xs text-gray-400">금</div><div class="text-xs text-blue-400">토</div>
                                </div>
                                <div id="overview-calendar-grid" class="calendar-grid rounded-lg overflow-hidden border border-gray-700 flex-1"></div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="glass-panel p-6 rounded-xl">
                                <h3 class="text-lg font-bold text-gray-200 mb-4">최근 업데이트된 프로젝트</h3>
                                <div id="overview-projects-list" class="space-y-3"></div>
                            </div>
                            <div class="glass-panel p-6 rounded-xl">
                                <h3 class="text-lg font-bold text-gray-200 mb-4">최근 업데이트된 인물</h3>
                                <div id="overview-contacts-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VIEW: ALL PROJECTS -->
                <div id="view-projects" class="h-full overflow-y-auto p-4 sm:p-8 hidden animate-slide-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-100">전체 프로젝트</h2>
                        <div class="flex gap-2">
                             <select id="project-sort-select" onchange="renderAllProjectsView()" class="bg-[#1e293b] border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 outline-none">
                                <option value="newest">최신순</option><option value="oldest">오래된순</option><option value="deadline">마감 임박순</option><option value="budget">예산 높은순</option>
                             </select>
                            <button onclick="openProjectModal('create')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-colors flex items-center gap-2"><i class="fa-solid fa-plus"></i> 새 프로젝트</button>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl overflow-hidden border border-gray-700/50">
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-[#1e293b]/50 border-b border-gray-700 text-xs font-bold text-gray-400 uppercase"><th class="px-6 py-4">프로젝트명</th><th class="px-6 py-4">클라이언트</th><th class="px-6 py-4">담당자</th><th class="px-6 py-4">마감 기한</th><th class="px-6 py-4">진행률</th><th class="px-6 py-4">총 예산 / 목표 매출</th><th class="px-6 py-4 text-center">상태</th><th class="px-6 py-4 text-right">관리</th></tr></thead><tbody id="projects-table-body" class="text-sm divide-y divide-gray-700/50"></tbody></table></div>
                    </div>
                </div>

                <!-- VIEW: DASHBOARD + BOARD -->
                <div id="view-board" class="h-full overflow-x-auto overflow-y-auto p-4 sm:p-8 hidden animate-slide-in">
                    <div class="glass-panel p-6 rounded-xl mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-l-4 border-indigo-500">
                        <div>
                            <div class="flex items-center gap-2 mb-1"><span id="dash-status-badge" class="px-2 py-0.5 rounded text-[10px] font-medium bg-gray-700 text-gray-300">상태</span><span class="text-xs text-gray-500" id="dash-proj-id">ID: -</span></div>
                            <div class="flex items-center gap-3 mb-2"><h2 class="text-2xl font-bold text-white" id="dash-proj-title">프로젝트 제목</h2><button onclick="openProjectModal('edit')" class="text-gray-500 hover:text-indigo-400 transition-colors" title="프로젝트 수정"><i class="fa-solid fa-pen-to-square"></i></button></div>
                            <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-400"><span class="flex items-center gap-2"><i class="fa-regular fa-building text-indigo-400"></i> <span id="dash-client-company">고객사</span></span><span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-indigo-400"></i> <span id="dash-proj-manager">담당자</span></span></div>
                        </div>
                        <div class="flex flex-col items-end gap-3">
                            <button onclick="openAiAnalysisModal()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white rounded-lg font-bold shadow-lg transition-all transform hover:scale-105 border border-white/10 group"><i class="fa-solid fa-wand-magic-sparkles text-yellow-300 group-hover:animate-pulse"></i> AI 리포트</button>
                            <div class="flex flex-col sm:flex-row gap-4 text-sm bg-[#0f172a]/40 p-3 rounded-lg border border-gray-700/50 w-full md:w-auto"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400"><i class="fa-regular fa-id-badge"></i></div><div><p class="text-xs text-gray-500">클라이언트</p><p class="font-medium text-gray-200" id="dash-client-name">-</p></div></div><div class="hidden sm:block w-px bg-gray-700 my-1"></div><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-gray-500">연락처</p><p class="font-medium text-gray-200" id="dash-client-contact">-</p></div></div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-panel p-5 rounded-xl border-l-4 border-indigo-500"><p class="text-sm text-gray-400 mb-1">총 예산</p><h3 id="stat-budget" class="text-2xl font-bold text-white">₩0.00만</h3></div>
                        <div class="glass-panel p-5 rounded-xl border-l-4 border-emerald-500"><p class="text-sm text-gray-400 mb-1">목표 매출</p><h3 id="stat-revenue" class="text-2xl font-bold text-white">₩0</h3></div>
                        <div class="glass-panel p-5 rounded-xl border-l-4 border-amber-500"><p class="text-sm text-gray-400 mb-1">진행중</p><h3 id="stat-inprogress" class="text-2xl font-bold text-white">0건</h3></div>
                        <div class="glass-panel p-5 rounded-xl border-l-4 border-rose-500"><p class="text-sm text-gray-400 mb-1">마감 임박</p><h3 id="stat-urgent" class="text-2xl font-bold text-white">0건</h3></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[500px]">
                        <div class="glass-panel p-6 rounded-xl flex flex-col lg:col-span-1"><h3 class="text-lg font-bold text-gray-200 mb-4"><i class="fa-solid fa-chart-line mr-2"></i>재무 현황</h3><div class="flex-1 relative w-full h-full min-h-[300px]"><canvas id="financeChart"></canvas></div></div>
                        <div class="glass-panel p-6 rounded-xl flex flex-col lg:col-span-2">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-200"><i class="fa-regular fa-calendar mr-2"></i>캘린더</h3><div class="flex items-center gap-2 bg-[#0f172a] rounded-lg p-1 border border-gray-700"><button onclick="changeMonth(-1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button><span id="calendar-month" class="text-sm text-gray-300 font-medium w-24 text-center"></span><button onclick="changeMonth(1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button></div></div>
                            <div class="flex-1 overflow-hidden flex flex-col"><div class="grid grid-cols-7 text-center mb-2"><div class="text-xs text-red-400">일</div><div class="text-xs text-gray-400">월</div><div class="text-xs text-gray-400">화</div><div class="text-xs text-gray-400">수</div><div class="text-xs text-gray-400">목</div><div class="text-xs text-gray-400">금</div><div class="text-xs text-blue-400">토</div></div><div id="calendar-grid" class="calendar-grid rounded-lg overflow-hidden border border-gray-700 flex-1"></div></div>
                        </div>
                    </div>
                    <div class="mt-10">
                        <div class="flex items-center justify-between mb-4">
                        <div class="text-sm text-gray-400">프로젝트 진행률</div>
                        <div class="text-sm text-gray-300"><span id="board-progress-percent">0</span>% (<span id="board-progress-count">0</span>/<span id="board-progress-total">0</span>)</div>
                        </div>
                        <div class="h-2 bg-gray-800 rounded-full overflow-hidden mb-6">
                        <div id="board-progress-bar" class="h-full bg-indigo-500 transition-all" style="width: 0%"></div>
                        </div>
                        <div class="flex gap-6 h-full min-w-[1000px] md:min-w-0">
                        <div class="flex-1 flex flex-col min-w-[300px] glass-panel rounded-xl p-4 h-full max-h-full">
                            <div class="flex items-center justify-between mb-4 px-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-gray-400"></div><h2 class="font-bold text-gray-300">할 일</h2><span id="count-todo" class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full text-xs font-bold border border-gray-600">0</span></div></div>
                            <div id="todo-container" class="column-drop-zone flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                        </div>
                        <div class="flex-1 flex flex-col min-w-[300px] glass-panel rounded-xl p-4 h-full max-h-full border-t-2 border-t-indigo-500/50">
                            <div class="flex items-center justify-between mb-4 px-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-indigo-500"></div><h2 class="font-bold text-indigo-300">진행 중</h2><span id="count-inprogress" class="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full text-xs font-bold border border-indigo-500/30">0</span></div></div>
                            <div id="inprogress-container" class="column-drop-zone flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide" ondrop="drop(event, 'inprogress')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                        </div>
                        <div class="flex-1 flex flex-col min-w-[300px] glass-panel rounded-xl p-4 h-full max-h-full">
                            <div class="flex items-center justify-between mb-4 px-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-500"></div><h2 class="font-bold text-amber-300">검토</h2><span id="count-review" class="bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded-full text-xs font-bold border border-amber-500/30">0</span></div></div>
                            <div id="review-container" class="column-drop-zone flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide" ondrop="drop(event, 'review')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                        </div>
                        <div class="flex-1 flex flex-col min-w-[300px] glass-panel rounded-xl p-4 h-full max-h-full">
                            <div class="flex items-center justify-between mb-4 px-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div><h2 class="font-bold text-emerald-300">완료</h2><span id="count-done" class="bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded-full text-xs font-bold border border-emerald-500/30">0</span></div></div>
                            <div id="done-container" class="column-drop-zone flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide" ondrop="drop(event, 'done')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                        </div>
                        <div class="kanban-divider"></div>
                        <div class="hold-room flex-1 flex flex-col min-w-[300px] glass-panel hold-panel rounded-xl p-4 h-full max-h-full">
                            <div class="flex items-center justify-between mb-4 px-1"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-500"></div><h2 class="font-bold text-slate-300">보류</h2><span id="count-hold" class="bg-slate-500/20 text-slate-300 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-500/30">0</span></div></div>
                            <div id="hold-container" class="column-drop-zone flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide" ondrop="drop(event, 'hold')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: CONTACTS -->
                <div id="view-contacts" class="h-full overflow-y-auto p-4 sm:p-8 hidden animate-slide-in">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-100">인물</h2>
                        <div class="flex gap-2 bg-[#0f172a] p-1 rounded-lg border border-gray-700 overflow-x-auto max-w-full"><button onclick="filterContacts('all')" class="filter-tab active px-4 py-1.5 text-xs font-bold rounded-md text-gray-300 hover:text-white transition-colors whitespace-nowrap" data-filter="all">전체</button><button onclick="filterContacts('의뢰 고객')" class="filter-tab px-4 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition-colors whitespace-nowrap" data-filter="의뢰 고객">의뢰 고객</button><button onclick="filterContacts('크리에이터')" class="filter-tab px-4 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition-colors whitespace-nowrap" data-filter="크리에이터">크리에이터</button><button onclick="filterContacts('장소관계자')" class="filter-tab px-4 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition-colors whitespace-nowrap" data-filter="장소관계자">장소관계자</button><button onclick="filterContacts('출연자')" class="filter-tab px-4 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:text-white transition-colors whitespace-nowrap" data-filter="출연자">출연자</button></div>
                        <button onclick="openContactModal('create')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-colors flex items-center gap-2 flex-shrink-0"><i class="fa-solid fa-plus"></i> 인물 추가</button>
                    </div>
                    <div id="contacts-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
                </div>
            </div>

        <!-- Modals -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl h-[70vh] flex flex-col">
                <div class="flex justify-between items-center p-6 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">설정</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-8">
                    <div>
                        <h4 class="text-sm font-bold text-indigo-400 uppercase mb-4 border-b border-gray-700 pb-2">일반 설정</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">회사명</label>
                                <div class="flex gap-2">
                                    <input type="text" id="company-name-input" class="flex-1 bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" placeholder="회사명을 입력하세요">
                                    <button onclick="saveCompanyName()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-bold">저장</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">테마</label>
                                <select id="theme-select" onchange="setThemeFromSelect()" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200">
                                    <option value="dark">다크 모드</option>
                                    <option value="light">라이트 모드</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-indigo-400 uppercase mb-4 border-b border-gray-700 pb-2">태그 관리</h4>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-tag-input" placeholder="새 태그 이름 (예: 기획)" class="flex-1 bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200">
                            <button onclick="addNewTag()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-bold">추가</button>
                        </div>
                        <div id="settings-tag-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profileModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">내 정보</h3>
                    <button onclick="closeProfileModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-300 font-bold border border-indigo-500/30">PD</div>
                        <div>
                            <div class="text-lg font-bold text-gray-100">변PD</div>
                            <div class="text-sm text-gray-500">Product Director</div>
                        </div>
                    </div>
                    <div class="bg-[#0f172a] rounded-lg p-4 border border-gray-700/50 text-sm text-gray-300 space-y-2">
                        <div>이메일: pd@creait.com</div>
                        <div>팀: 기획</div>
                        <div>권한: 관리자</div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex justify-end">
                    <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">닫기</button>
                </div>
            </div>
        </div>

        <div id="accountModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">계정 관리</h3>
                    <button onclick="closeAccountModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">이름</label>
                        <input type="text" id="account-name" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" value="변PD">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">이메일</label>
                        <input type="email" id="account-email" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" value="pd@creait.com">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">역할</label>
                        <input type="text" id="account-role" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" value="Product Director">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                    <button onclick="closeAccountModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button>
                    <button onclick="saveAccountSettings()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold">저장</button>
                </div>
            </div>
        </div>

        <div id="taskDetailModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-4xl h-[85vh] transform transition-all scale-100 flex overflow-hidden">
                <div class="task-detail-main flex-1 flex flex-col border-r border-gray-700">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-start">
                        <div>
                            <div class="text-xs text-gray-500 mb-2 flex items-center gap-2">
                                <span class="uppercase tracking-wider" id="detail-project-title">프로젝트</span>
                                <i class="fa-solid fa-chevron-right text-[10px]"></i>
                                <span id="detail-task-id">ID</span>
                            </div>
                            <h2 id="detail-title" class="text-2xl font-bold text-gray-100 leading-tight">업무 제목</h2>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                        <div class="task-tabs flex items-center">
                            <button id="task-tab-btn-details" onclick="switchTaskTab('details')" class="task-tab active">상세</button>
                            <button id="task-tab-btn-attachments" onclick="switchTaskTab('attachments')" class="task-tab">첨부</button>
                        </div>
                        <div id="task-tab-details" class="space-y-6">
                            <div class="section-block">
                                <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">상세 내용</h3>
                                <textarea id="detail-desc" rows="6" oninput="updateTaskDesc(this.value)" onkeydown="handleDescKeydown(event)" class="task-desc-area w-full bg-[#0f172a] border border-gray-700 rounded-lg p-3 text-sm text-gray-200 focus:outline-none focus:border-indigo-500 resize-none" placeholder="업무 상세 내용을 입력하세요"></textarea>
                            </div>
                            <div class="section-block">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-bold text-gray-400 uppercase">커스텀 필드</h3>
                                    <button onclick="openCustomFieldModal()" class="text-xs text-indigo-400 hover:text-indigo-300">+ 추가</button>
                                </div>
                                <div id="custom-field-list" class="space-y-2"></div>
                            </div>
                            <div class="section-block">
                                <h3 class="text-sm font-bold text-gray-400 uppercase mb-4">타임라인</h3>
                                <div class="space-y-4 mb-4" id="detail-comment-list"></div>
                                <div class="flex gap-3 items-start bg-[#0f172a]/30 p-3 rounded-lg border border-gray-700/50">
                                    <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex-shrink-0 flex items-center justify-center text-indigo-300 font-bold border border-indigo-500/30 text-xs">PD</div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <label class="text-xs text-gray-500">관련 인물:</label>
                                            <select id="timeline-target-select" class="bg-[#1e293b] text-xs text-gray-300 border border-gray-700 rounded px-2 py-1 outline-none">
                                                <option value="">없음 (단순 기록)</option>
                                            </select>
                                        </div>
                                        <textarea id="new-comment-input" rows="2" placeholder="업무 내용, 연락 기록 등을 작성하세요..." class="w-full bg-[#0f172a] border border-gray-700 rounded-lg p-3 text-sm text-gray-200 focus:outline-none focus:border-indigo-500 resize-none mb-2"></textarea>
                                        <div class="flex justify-end">
                                            <button onclick="addComment()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors">기록하기</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="task-tab-attachments" class="hidden space-y-3">
                            <div class="section-block">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-sm font-bold text-gray-400 uppercase">첨부파일</h3>
                                    <label class="text-xs text-indigo-400 hover:text-indigo-300 cursor-pointer">
                                        <input id="task-attachment-input" type="file" multiple class="hidden" onchange="handleAttachmentUpload(event)">
                                        + 파일 추가
                                    </label>
                                </div>
                                <div id="attachment-list" class="space-y-2 mt-2"></div>
                                <p class="text-[11px] text-gray-500 mt-2">* 첨부파일은 브라우저에만 저장됩니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="task-detail-side w-80 flex flex-col p-6 space-y-6 overflow-y-auto">
                    <div class="flex justify-end gap-2 mb-2">
                        <button onclick="editFromDetail()" class="text-gray-400 hover:text-indigo-400 p-2 rounded hover:bg-white/5 transition-colors" title="수정"><i class="fa-solid fa-pen-to-square text-lg"></i></button>
                        <button onclick="deleteFromDetail()" class="text-gray-400 hover:text-red-400 p-2 rounded hover:bg-white/5 transition-colors" title="삭제"><i class="fa-solid fa-trash-can text-lg"></i></button>
                        <button onclick="closeTaskDetail()" class="text-gray-400 hover:text-gray-200 p-2 rounded hover:bg-white/5 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">상태</label>
                            <select id="detail-status" onchange="updateTaskMeta('status', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200 focus:outline-none focus:border-indigo-500">
                                <option value="todo">할 일 (To Do)</option>
                                <option value="inprogress">진행 중 (In Progress)</option>
                                <option value="review">검토 (Review)</option>
                                <option value="done">완료 (Done)</option>
                                <option value="hold">보류 (On Hold)</option>
                            </select>
                        </div>
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">담당자</label>
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-300 text-xs" id="detail-assignee-avatar"></div>
                                <span id="detail-assignee-name" class="text-sm text-gray-200"></span>
                            </div>
                        </div>
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">마감일</label>
                            <input type="date" id="detail-date" onchange="updateTaskMeta('date', this.value)" class="w-full bg-transparent text-sm text-gray-200 focus:outline-none dark-date-input">
                        </div>
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">비용 (원)</label>
                            <input type="number" id="detail-cost" step="1" min="0" onchange="updateTaskMeta('cost', this.value)" class="w-full bg-transparent text-sm text-gray-200 focus:outline-none" placeholder="0">
                        </div>
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">우선순위</label>
                            <select id="detail-priority" onchange="updateTaskMeta('priority', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200 focus:outline-none focus:border-indigo-500">
                                <option value="High">🔴 높음 (High)</option>
                                <option value="Medium">🟠 보통 (Medium)</option>
                                <option value="Low">🔵 낮음 (Low)</option>
                            </select>
                        </div>
                        <div class="p-3 rounded-lg bg-[#1e293b] border border-gray-700/50">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">태그</label>
                            <span id="detail-tag" class="inline-block px-3 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300">Tag</span>
                        </div>
                    </div>
                    <div class="mt-auto pt-6 border-t border-gray-700 text-xs text-gray-500 text-center">생성일: <span id="detail-created-at">-</span></div>
                </div>
            </div>
        </div>

        <div id="contactDetailModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4"><div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all scale-100 flex overflow-hidden max-h-[90vh]"><div class="flex-1 flex flex-col"><div class="p-6 border-b border-gray-700 flex justify-between items-start bg-[#0f172a]/30"><div class="flex items-center gap-4"><div id="detail-contact-avatar" class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center text-2xl text-indigo-300 font-bold border border-indigo-500/30">-</div><div><div class="flex items-center gap-2 mb-1"><h2 id="detail-contact-name" class="text-2xl font-bold text-gray-100">이름</h2><span id="detail-contact-category" class="px-2 py-0.5 rounded text-[10px] bg-gray-700 text-gray-300">구분</span></div><p id="detail-contact-info" class="text-sm text-indigo-400 font-medium">소속 | 직함</p></div></div><div class="flex gap-2"><button onclick="editContactFromDetail()" class="text-gray-400 hover:text-indigo-400 p-2 rounded hover:bg-white/5 transition-colors" title="수정"><i class="fa-solid fa-pen-to-square text-lg"></i></button><button onclick="closeContactDetail()" class="text-gray-400 hover:text-gray-200 p-2 rounded hover:bg-white/5 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button></div></div><div class="flex-1 overflow-y-auto p-6 custom-scrollbar"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><h3 class="text-sm font-bold text-gray-400 uppercase border-b border-gray-700 pb-2">기본 정보</h3><div class="space-y-3"><div class="flex items-start gap-3"><div class="w-8 h-8 rounded bg-[#0f172a] flex items-center justify-center text-gray-500"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-gray-500">연락처</p><p id="detail-contact-phone" class="text-sm text-gray-200">-</p></div></div><div class="flex items-start gap-3"><div class="w-8 h-8 rounded bg-[#0f172a] flex items-center justify-center text-gray-500"><i class="fa-solid fa-envelope"></i></div><div><p class="text-xs text-gray-500">이메일</p><p id="detail-contact-email" class="text-sm text-gray-200">-</p></div></div><div class="flex items-start gap-3"><div class="w-8 h-8 rounded bg-[#0f172a] flex items-center justify-center text-gray-500"><i class="fa-solid fa-fax"></i></div><div><p class="text-xs text-gray-500">팩스</p><p id="detail-contact-fax" class="text-sm text-gray-200">-</p></div></div><div class="flex items-start gap-3"><div class="w-8 h-8 rounded bg-[#0f172a] flex items-center justify-center text-gray-500"><i class="fa-solid fa-location-dot"></i></div><div><p class="text-xs text-gray-500">주소</p><p id="detail-contact-address" class="text-sm text-gray-200">-</p></div></div></div></div><div class="space-y-6"><div><h3 class="text-sm font-bold text-gray-400 uppercase border-b border-gray-700 pb-2 mb-3">연관 프로젝트</h3><div id="detail-contact-projects" class="space-y-2"><p class="text-xs text-gray-500">연관된 프로젝트가 없습니다.</p></div></div><div><h3 class="text-sm font-bold text-gray-400 uppercase border-b border-gray-700 pb-2 mb-3">관리자 메모</h3><div class="bg-[#0f172a] rounded-lg p-3 border border-gray-700/50 min-h-[80px]"><p id="detail-contact-memo" class="text-sm text-gray-300 whitespace-pre-wrap">-</p></div></div></div></div></div></div></div></div>

        <div id="contactModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4"><div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg transform transition-all scale-100 animate-slide-in flex flex-col max-h-[90vh]"><div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0"><h3 class="text-lg font-bold text-gray-100">인물 정보</h3><button onclick="closeContactModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 overflow-y-auto flex-1 custom-scrollbar"><form onsubmit="handleContactSubmit(event)"><div class="grid grid-cols-2 gap-4 mb-4"><div class="col-span-1"><label class="block text-sm font-medium text-gray-400 mb-1">이름</label><input type="text" id="contact-name" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="홍길동"></div><div class="col-span-1"><label class="block text-sm font-medium text-gray-400 mb-1">구분 (역할)</label><select id="contact-category" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"><option value="기타">선택하세요</option><option value="의뢰 고객">의뢰 고객</option><option value="크리에이터">크리에이터</option><option value="장소관계자">장소관계자</option><option value="출연자">출연자</option><option value="기타">기타</option></select></div></div><div class="grid grid-cols-2 gap-3 mb-4"><div><label class="block text-sm font-medium text-gray-400 mb-1">회사명</label><input type="text" id="contact-company" placeholder="(주)크리에잇" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">부서/직함</label><input type="text" id="contact-role" placeholder="기획 팀장" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div></div><div class="grid grid-cols-2 gap-3 mb-4"><div><label class="block text-sm font-medium text-gray-400 mb-1">연락처</label><input type="text" id="contact-phone" placeholder="010-0000-0000" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">이메일</label><input type="email" id="contact-email" placeholder="email@example.com" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div></div><div class="grid grid-cols-2 gap-3 mb-4"><div><label class="block text-sm font-medium text-gray-400 mb-1">팩스</label><input type="text" id="contact-fax" placeholder="02-000-0000" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div><div></div></div><div class="mb-4"><label class="block text-sm font-medium text-gray-400 mb-1">주소</label><input type="text" id="contact-address" placeholder="서울시..." class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-400 mb-1">관리자 메모</label><textarea id="contact-memo" rows="3" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="비고 사항을 입력하세요"></textarea></div><div class="flex justify-end gap-3"><button type="button" onclick="closeContactModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button><button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold">저장</button></div></form></div></div></div>

        <div id="taskModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg transform transition-all scale-100 animate-slide-in flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0">
                    <h3 id="modalTitle" class="text-lg font-bold text-gray-100">새 업무 추가</h3>
                    <button onclick="closeTaskModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                    <form id="addTaskForm" onsubmit="handleTaskSubmit(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">업무 제목</label>
                            <input type="text" id="taskTitle" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="업무 제목">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">업무 내용</label>
                            <textarea id="taskDescInput" rows="3" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="업무 상세 내용을 입력하세요"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">마감일</label>
                                <input type="date" id="taskDateInput" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none dark-date-input">
                                <label class="mt-2 date-toggle cursor-pointer">
                                    <input id="taskDateNone" type="checkbox" onclick="toggleTaskDateNone(this.checked)">
                                    <span class="date-toggle__track"><span class="date-toggle__thumb"></span></span>
                                    <span class="date-toggle__label">마감일 없음</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">담당자</label>
                                <select id="taskAssigneeInput" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="Me">변PD (Me)</option>
                                    <option value="Kim">김기획</option>
                                    <option value="Lee">이디자인</option>
                                    <option value="Park">박개발</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-1">우선순위</label>
                                <select id="taskPriorityInput" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="High">🔴 높음 (High)</option>
                                    <option value="Medium">🟠 보통 (Medium)</option>
                                    <option value="Low">🔵 낮음 (Low)</option>
                                </select>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <label class="block text-sm font-medium text-gray-400">태그</label>
                                    <button type="button" onclick="openTagManagerModal()" class="text-xs text-indigo-400 hover:text-indigo-300">태그 수정</button>
                                </div>
                                <select id="taskTagInput" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-400 mb-1">비용 (원)</label>
                            <input type="number" id="taskCostInput" step="1" min="0" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0">
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeTaskModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold">저장</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="tagManagerModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[75] flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-5 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">태그 관리</h3>
                    <button onclick="closeTagManagerModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="flex gap-2">
                        <input type="text" id="tag-manager-input" placeholder="새 태그 입력" class="flex-1 bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200">
                        <button onclick="addTagFromManager()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-bold">추가</button>
                    </div>
                    <div id="tag-manager-list" class="space-y-2"></div>
                    <p class="text-[11px] text-gray-500">* 태그를 삭제하면 해당 업무의 태그 정보가 비워집니다.</p>
                </div>
            </div>
        </div>

        <div id="tagDeleteModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-sm flex flex-col overflow-hidden">
                <div class="p-5 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">태그 삭제</h3>
                </div>
                <div class="p-5 space-y-3">
                    <p id="tag-delete-message" class="text-sm text-gray-300"></p>
                    <p class="text-xs text-gray-500">삭제하면 복구할 수 없습니다.</p>
                </div>
                <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                    <button onclick="closeTagDeleteModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button>
                    <button onclick="confirmDeleteTag()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">삭제</button>
                </div>
            </div>
        </div>

        <div id="customFieldModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
            <div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-700">
                    <h3 class="text-lg font-bold text-gray-100">커스텀 필드 추가</h3>
                    <button onclick="closeCustomFieldModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">필드 이름</label>
                        <input type="text" id="custom-field-label" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" placeholder="예: 우선 협의 사항">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">데이터 타입</label>
                        <select id="custom-field-type" onchange="toggleCustomFieldOptions()" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200">
                            <option value="text">텍스트</option>
                            <option value="number">숫자</option>
                            <option value="date">날짜</option>
                            <option value="time">시간</option>
                            <option value="boolean">토글</option>
                            <option value="single">단일선택 리스트</option>
                            <option value="multi">복수선택 리스트</option>
                        </select>
                    </div>
                    <div id="custom-field-options-wrap" class="hidden">
                        <label class="block text-sm text-gray-400 mb-2">옵션 목록</label>
                        <input type="text" id="custom-field-options" class="w-full bg-[#0f172a] border border-gray-700 rounded px-3 py-2 text-sm text-gray-200" placeholder="예: A, B, C">
                        <p class="text-[11px] text-gray-500 mt-1">쉼표로 구분해서 입력하세요.</p>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                    <button onclick="closeCustomFieldModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button>
                    <button onclick="handleAddCustomField()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold">추가</button>
                </div>
            </div>
        </div>

        <div id="projectModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]"><div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0"><h3 id="projModalTitle" class="text-lg font-bold text-gray-100">새 프로젝트 생성</h3><button onclick="closeProjectModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 overflow-y-auto flex-1 custom-scrollbar"><form id="projectForm" onsubmit="handleProjectSubmit(event)"><div class="grid grid-cols-2 gap-4 mb-4"><div class="col-span-2"><label class="block text-sm font-medium text-gray-400 mb-1">프로젝트명</label><input type="text" id="projTitle" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div><div class="col-span-2"><label class="block text-sm font-medium text-gray-400 mb-1">담당자 (PM)</label><select id="projManager" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none"><option value="변PD">변PD (기본)</option></select></div></div><div class="mb-6 bg-[#0f172a]/50 p-4 rounded-lg border border-gray-700/50"><label class="block text-sm font-medium text-indigo-400 mb-3">현재 진행 상태</label><div class="grid grid-cols-4 gap-2"><input type="radio" name="status" id="status-plan" value="기획" class="hidden status-radio" checked><label for="status-plan" class="cursor-pointer text-center py-2 rounded-lg border border-gray-600 text-xs text-gray-400 hover:bg-gray-700 transition-all font-bold">🌱 기획</label><input type="radio" name="status" id="status-progress" value="진행중" class="hidden status-radio"><label for="status-progress" class="cursor-pointer text-center py-2 rounded-lg border border-gray-600 text-xs text-gray-400 hover:bg-gray-700 transition-all font-bold">🚀 진행중</label><input type="radio" name="status" id="status-done" value="완료" class="hidden status-radio"><label for="status-done" class="cursor-pointer text-center py-2 rounded-lg border border-gray-600 text-xs text-gray-400 hover:bg-gray-700 transition-all font-bold">🎉 완료</label><input type="radio" name="status" id="status-hold" value="보류" class="hidden status-radio"><label for="status-hold" class="cursor-pointer text-center py-2 rounded-lg border border-gray-600 text-xs text-gray-400 hover:bg-gray-700 transition-all font-bold">⏸ 보류</label></div></div><div class="mb-4"><label class="block text-sm font-medium text-gray-400 mb-1">마감 기한 (D-Day)</label><input type="date" id="projDeadline" class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none dark-date-input"></div><div class="border-t border-gray-700 my-4 pt-4"><h4 class="text-sm font-bold text-gray-300 mb-3">클라이언트 정보</h4><div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label class="block text-xs font-medium text-gray-500 mb-1">회사명</label><input type="text" id="clientCompany" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">담당자명</label><input type="text" id="clientName" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">연락처</label><input type="text" id="clientContact" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div></div></div><div class="grid grid-cols-2 gap-4 mb-4 pt-2"><div><label class="block text-sm font-medium text-gray-400 mb-1">예산 (원)</label><input type="text" id="projBudget" inputmode="numeric" pattern="[0-9,]*" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div><div><label class="block text-sm font-medium text-gray-400 mb-1">목표 매출 (원)</label><input type="text" id="projRevenue" inputmode="numeric" pattern="[0-9,]*" required class="w-full px-4 py-2 bg-[#0f172a] border border-gray-700 rounded-lg text-gray-100"></div></div><div class="mb-6 flex items-center gap-2"><input type="checkbox" id="projVat" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-[#0f172a]"><label for="projVat" class="text-xs text-gray-400 select-none cursor-pointer">VAT 별도 (체크 시 별도)</label></div><div class="mb-4"><label class="block text-sm font-medium text-gray-400 mb-1">테마 컬러</label><div class="flex gap-2"><button type="button" onclick="selectColor('indigo')" class="w-8 h-8 rounded-full bg-indigo-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent hover:ring-indigo-400 color-btn" data-color="indigo"></button><button type="button" onclick="selectColor('emerald')" class="w-8 h-8 rounded-full bg-emerald-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent hover:ring-emerald-400 color-btn" data-color="emerald"></button><button type="button" onclick="selectColor('rose')" class="w-8 h-8 rounded-full bg-rose-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent hover:ring-rose-400 color-btn" data-color="rose"></button><button type="button" onclick="selectColor('amber')" class="w-8 h-8 rounded-full bg-amber-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-transparent hover:ring-amber-400 color-btn" data-color="amber"></button></div><input type="hidden" id="projColor" value="indigo"></div><div id="projDates" class="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-500 text-center"></div><div class="flex justify-end gap-3 pt-2 mt-2"><button type="button" onclick="closeProjectModal()" class="px-4 py-2 text-gray-400 hover:text-gray-200">취소</button><button type="submit" id="projSubmitBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold">저장</button></div></form></div></div></div>
        
        <!-- AI Report Modal (Same) -->
        <div id="aiAnalysisModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div class="bg-[#1e293b] border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col"><div class="flex justify-between items-center p-6 border-b border-gray-700 flex-shrink-0"><div class="flex items-center gap-2"><i class="fa-solid fa-robot text-indigo-400 text-xl"></i><h3 class="text-xl font-bold text-gray-100">AI 프로젝트 리포트</h3></div><button onclick="closeAiAnalysisModal()" class="text-gray-500 hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-8 overflow-y-auto flex-1 relative"><div id="ai-report-loading" class="absolute inset-0 bg-[#1e293b] flex flex-col items-center justify-center z-10"><div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-indigo-400 font-medium animate-pulse text-lg">분석 중...</p></div><div id="ai-report-content" class="markdown-body"></div></div><div class="p-6 border-t border-gray-700 bg-[#0f172a]/50 rounded-b-xl flex justify-end"><button onclick="closeAiAnalysisModal()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium">닫기</button></div></div></div>

        <div id="toast" class="fixed bottom-10 right-4 bg-[#1e293b] border border-gray-700 text-gray-100 px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-[70]"><i class="fa-solid fa-circle-check text-green-400"></i><span id="toastMsg">완료.</span></div>

        <!-- Live Clock (New Widget) -->
        <div id="live-clock" class="fixed bottom-2 right-4 text-[11px] text-gray-500 font-mono z-40 select-none bg-[#0f172a]/50 px-2 py-0.5 rounded border border-gray-800/50 backdrop-blur-sm"></div>
    </main>

    <script>
        const apiKey = "AIzaSyDZGK5DMLiIF4zkArmsvxAZAa-ZbA2YpPQ";
        
        // --- Data Definitions (Moved to Top) ---
        const defaultProjects = [
            { id: 'p1', title: '2024 S/S 패션 룩북 영상', manager: '변PD', clientCompany: '어반스타일', clientName: '김스타일', clientContact: '010-1234-1234', budget: 1500, revenue: 3000, color: 'rose', status: '진행중', vat: true, deadline: '2025-11-20', createdAt: '2025-10-01', updatedAt: '2025-10-25' },
            { id: 'p2', title: '신인 아이돌 "Spark" MV', manager: '송감독', clientCompany: '스타엔터', clientName: '이프로듀서', clientContact: '010-5678-5678', budget: 12000, revenue: 15000, color: 'indigo', status: '기획', vat: true, deadline: '2025-12-15', createdAt: '2025-10-05', updatedAt: '2025-10-10' },
            { id: 'p3', title: 'OO전자 공기청정기 TVCF', manager: '변PD', clientCompany: 'OO전자', clientName: '박마케터', clientContact: '010-9999-8888', budget: 25000, revenue: 40000, color: 'emerald', status: '보류', vat: false, deadline: '2026-01-10', createdAt: '2025-09-20', updatedAt: '2025-10-01' },
            { id: 'p4', title: '배달앱 "먹자" 바이럴', manager: '김기획', clientCompany: '우아한형제들', clientName: '최팀장', clientContact: '010-7777-1111', budget: 800, revenue: 1500, color: 'amber', status: '완료', vat: true, deadline: '2025-10-10', createdAt: '2025-08-01', updatedAt: '2025-10-11' },
            { id: 'p5', title: 'IT 스타트업 채용 홍보 영상', manager: '박개발', clientCompany: '토스랩', clientName: '정인사', clientContact: '010-2222-3333', budget: 2000, revenue: 3500, color: 'blue', status: '진행중', vat: true, deadline: '2025-11-30', createdAt: '2025-10-15', updatedAt: '2025-10-20' },
            { id: 'p6', title: '유튜브 웹예능 "술술술" EP.1', manager: '송감독', clientCompany: '샌드박스', clientName: '강PD', clientContact: '010-4444-5555', budget: 500, revenue: 800, color: 'orange', status: '검토', vat: true, deadline: '2025-10-30', createdAt: '2025-10-01', updatedAt: '2025-10-26' },
            { id: 'p7', title: '신작 게임 시네마틱 트레일러', manager: '변PD', clientCompany: '넥슨', clientName: '유개발', clientContact: '010-6666-7777', budget: 50000, revenue: 80000, color: 'purple', status: '기획', vat: true, deadline: '2026-03-01', createdAt: '2025-10-20', updatedAt: '2025-10-22' },
            { id: 'p8', title: '비건 화장품 인스타 숏폼 5종', manager: '이디자인', clientCompany: '네이처', clientName: '한대표', clientContact: '010-8888-9999', budget: 300, revenue: 600, color: 'teal', status: '진행중', vat: false, deadline: '2025-11-05', createdAt: '2025-10-18', updatedAt: '2025-10-25' },
            { id: 'p9', title: '지자체 관광 홍보 다큐', manager: '김기획', clientCompany: '제주시청', clientName: '오주무관', clientContact: '010-0000-1111', budget: 3500, revenue: 5000, color: 'cyan', status: '검토', vat: true, deadline: '2025-11-15', createdAt: '2025-09-01', updatedAt: '2025-10-24' },
            { id: 'p10', title: '금융 앱 사용법 튜토리얼', manager: '박개발', clientCompany: '카카오뱅크', clientName: '송매니저', clientContact: '010-1212-3434', budget: 1000, revenue: 1800, color: 'slate', status: '완료', vat: true, deadline: '2025-09-30', createdAt: '2025-08-15', updatedAt: '2025-10-01' }
        ];

        const defaultTasks = [
            { id: 't1', projectId: 'p1', title: '모델 A급 섭외 (3명)', desc: 'S/S 시즌에 맞는 청량한 이미지 모델 섭외 필요. 에이전시 컨택 완료.', tag: '기획', priority: 'High', status: 'done', date: '2025-10-15', assignee: '김기획', cost: 400, subtasks: [{id: 's1', text: '에이전시 리스트업', done: true}, {id: 's2', text: '프로필 전달 및 1차 셀렉', done: true}, {id: 's3', text: '계약서 날인', done: true}], comments: [{id: 'c1', text: '모델 스케줄 픽스되었습니다.', author: '김기획', date: '2025-10-12', time: '10:00', target: '최대표'}, {id: 'c2', text: '의상 피팅 일정 잡아주세요.', author: '변PD', date: '2025-10-13', time: '14:30', target: '김기획'}] },
            { id: 't2', projectId: 'p1', title: '성수동 스튜디오 렌탈', desc: '자연광 잘 들어오는 호리존 스튜디오 필요. 11/5 촬영 예정.', tag: '제작', priority: 'Medium', status: 'done', date: '2025-10-20', assignee: '변PD', cost: 80, subtasks: [{id: 's4', text: '스튜디오 답사', done: true}, {id: 's5', text: '예약금 입금', done: true}], comments: [] },
            { id: 't3', projectId: 'p1', title: '촬영 장비/조명 렌탈', desc: 'Arri Alexa Mini, Cook 렌즈 세트, Aputure 600d 2대', tag: '제작', priority: 'High', status: 'inprogress', date: '2025-11-04', assignee: '변PD', cost: 150, subtasks: [{id: 's6', text: '렌탈샵 견적 비교', done: true}, {id: 's7', text: '장비 픽업 및 테스트', done: false}], comments: [{id: 'c3', text: '조명 감독님이 1200d 추가 요청하셨습니다.', author: '송감독', date: '2025-10-26', time: '09:15', target: '변PD'}] },
            { id: 't4', projectId: 'p1', title: '편집/색보정 (DI)', desc: '밝고 채도 높은 톤앤매너 유지. 컷편집 1차 11/10까지.', tag: '편집', priority: 'High', status: 'todo', date: '2025-11-15', assignee: '이디자인', cost: 0, subtasks: [], comments: [] },
            { id: 't19', projectId: 'p1', title: '룩북 콘셉트 보드 확정', desc: '무드보드 최종안 확정 및 레퍼런스 정리.', tag: '기획', priority: 'Medium', status: 'done', date: '2025-10-10', assignee: '김기획', cost: 0, subtasks: [], comments: [] },
            { id: 't20', projectId: 'p1', title: '로케이션 허가 확인', desc: '촬영 장소 사용 허가 및 촬영 시간 협의.', tag: '제작', priority: 'Medium', status: 'review', date: '2025-10-28', assignee: '변PD', cost: 0, subtasks: [], comments: [] },
            { id: 't5', projectId: 'p2', title: '뮤직비디오 콘티 제작', desc: '곡 분위기: 청량, 하이틴. 학교 배경 세트장 필요.', tag: '기획', priority: 'High', status: 'inprogress', date: '2025-10-30', assignee: '송감독', cost: 200, subtasks: [{id: 's8', text: '레퍼런스 영상 수집', done: true}, {id: 's9', text: '씬 리스트 작성', done: true}, {id: 's10', text: '스토리보드 작화', done: false}], comments: [{id: 'c4', text: '댄스 브레이크 구간 조명 연출 아이디어 필요합니다.', author: '송감독', date: '2025-10-24', time: '11:00', target: '이디자인'}] },
            { id: 't6', projectId: 'p2', title: '미술/소품팀 미팅', desc: '교실 세트, 옥상 세트 제작 견적 산출', tag: '기획', priority: 'Medium', status: 'todo', date: '2025-11-02', assignee: '김기획', cost: 0, subtasks: [], comments: [] },
            { id: 't21', projectId: 'p2', title: '안무팀 리허설 촬영', desc: '포인트 안무 구간 프리비주용 리허설 촬영.', tag: '제작', priority: 'Medium', status: 'review', date: '2025-10-27', assignee: '송감독', cost: 30, subtasks: [], comments: [] },
            { id: 't22', projectId: 'p2', title: '아티스트 스타일링 협의', desc: '의상 콘셉트 및 피팅 일정 확정.', tag: '기획', priority: 'High', status: 'inprogress', date: '2025-10-29', assignee: '김기획', cost: 0, subtasks: [], comments: [] },
            { id: 't7', projectId: 'p3', title: '광고주 킥오프 미팅', desc: '제품 USP 확인, 타겟 오디언스 설정', tag: '마케팅', priority: 'High', status: 'done', date: '2025-09-25', assignee: '변PD', cost: 10, subtasks: [], comments: [] },
            { id: 't8', projectId: 'p3', title: '메인 모델 계약 검토', desc: '모델 이슈로 인해 보류 중', tag: '기획', priority: 'High', status: 'review', date: '2025-10-05', assignee: '변PD', cost: 0, comments: [{id: 'c5', text: '광고주 측에서 모델 변경 요청왔습니다. 잠시 홀드.', author: '변PD', date: '2025-10-01', time: '16:00', target: '김기획'}] },
            { id: 't23', projectId: 'p3', title: 'CF 스크립트 수정안', desc: '2차 시안 반영, 메시지 톤 다운.', tag: '기획', priority: 'Medium', status: 'inprogress', date: '2025-10-12', assignee: '김기획', cost: 0, comments: [] },
            { id: 't24', projectId: 'p3', title: '제품 촬영 세트 테스트', desc: '고스트 반사 체크 및 라이팅 테스트.', tag: '제작', priority: 'Medium', status: 'todo', date: '2025-10-14', assignee: '박개발', cost: 60, comments: [] },
            { id: 't9', projectId: 'p4', title: '최종 납품 완료', desc: '유튜브용, 인스타용 포맷 변환 후 전달 완료', tag: '편집', priority: 'High', status: 'done', date: '2025-10-10', assignee: '박개발', cost: 0, subtasks: [{id: 's11', text: '최종본 랜더링', done: true}, {id: 's12', text: '클린본 전달', done: true}], comments: [] },
            { id: 't25', projectId: 'p4', title: '바이럴 카피 점검', desc: '플랫폼별 문구 톤앤매너 맞춤.', tag: '마케팅', priority: 'Low', status: 'done', date: '2025-10-07', assignee: '김기획', cost: 0, comments: [] },
            { id: 't26', projectId: 'p4', title: '광고 성과 리포트', desc: '도달/전환 지표 요약 보고서 작성.', tag: '마케팅', priority: 'Medium', status: 'review', date: '2025-10-12', assignee: '변PD', cost: 0, comments: [] },
            { id: 't10', projectId: 'p5', title: '임직원 인터뷰 촬영', desc: '개발팀, 디자인팀 리드급 인터뷰 진행. 판교 오피스.', tag: '제작', priority: 'Medium', status: 'done', date: '2025-10-18', assignee: '박개발', cost: 50, subtasks: [], comments: [] },
            { id: 't11', projectId: 'p5', title: '인터뷰 자막 디자인', desc: '기업 로고 컬러 활용한 깔끔한 자막 템플릿', tag: '디자인', priority: 'Medium', status: 'inprogress', date: '2025-10-30', assignee: '이디자인', cost: 0, comments: [{id: 'c6', text: '폰트는 산돌고딕으로 통일해주세요.', author: '박개발', date: '2025-10-25', time: '13:00', target: '이디자인'}] },
            { id: 't27', projectId: 'p5', title: '채용 브랜딩 메시지 확정', desc: '기업 문화 강조 문구 확정 및 검수.', tag: '기획', priority: 'High', status: 'review', date: '2025-10-26', assignee: '김기획', cost: 0, comments: [] },
            { id: 't28', projectId: 'p5', title: '모션그래픽 오프닝', desc: '인트로 10초 모션그래픽 제작.', tag: '디자인', priority: 'Medium', status: 'todo', date: '2025-11-01', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't12', projectId: 'p6', title: '가편집 시사 (내부)', desc: '재미없는 부분 덜어내기, 텐션 올리기', tag: '편집', priority: 'High', status: 'review', date: '2025-10-25', assignee: '송감독', cost: 0, comments: [{id: 'c7', text: '오프닝이 너무 깁니다. 1분 안으로 줄여주세요.', author: '변PD', date: '2025-10-25', time: '10:00', target: '송감독'}] },
            { id: 't13', projectId: 'p6', title: '썸네일 제작', desc: '클릭률 높은 자극적인 카피 필요', tag: '디자인', priority: 'High', status: 'todo', date: '2025-10-28', assignee: '이디자인', cost: 0, subtasks: [], comments: [] },
            { id: 't29', projectId: 'p6', title: '게스트 섭외 확정', desc: '1회차 게스트 출연 협의 완료.', tag: '기획', priority: 'Medium', status: 'done', date: '2025-10-12', assignee: '김기획', cost: 0, comments: [] },
            { id: 't30', projectId: 'p6', title: '촬영 장소 예약', desc: '바 예약 및 촬영 시간 확정.', tag: '제작', priority: 'Medium', status: 'inprogress', date: '2025-10-22', assignee: '변PD', cost: 30, comments: [] },
            { id: 't14', projectId: 'p7', title: 'CGI 업체 선정', desc: '고퀄리티 3D 모델링 가능한 외주사 컨택', tag: '제작', priority: 'High', status: 'inprogress', date: '2025-11-10', assignee: '변PD', cost: 0, subtasks: [], comments: [] },
            { id: 't31', projectId: 'p7', title: '콘셉트 아트 1차', desc: '세계관/캐릭터 톤 1차 스케치.', tag: '디자인', priority: 'High', status: 'review', date: '2025-10-30', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't32', projectId: 'p7', title: '사운드 디자인 가이드', desc: '트레일러 사운드 레퍼런스 확정.', tag: '제작', priority: 'Low', status: 'todo', date: '2025-11-05', assignee: '박개발', cost: 0, comments: [] },
            { id: 't15', projectId: 'p8', title: '제품 누끼 촬영', desc: '자연광 활용, 인스타 감성', tag: '제작', priority: 'Medium', status: 'done', date: '2025-10-22', assignee: '이디자인', cost: 20, subtasks: [], comments: [] },
            { id: 't16', projectId: 'p8', title: '숏폼 편집 (5편)', desc: '빠른 호흡, 트랜지션 효과', tag: '편집', priority: 'High', status: 'inprogress', date: '2025-11-01', assignee: '이디자인', cost: 0, subtasks: [], comments: [] },
            { id: 't33', projectId: 'p8', title: '인스타 스토리 템플릿', desc: '브랜드 톤에 맞춘 스토리 템플릿 제작.', tag: '디자인', priority: 'Medium', status: 'review', date: '2025-10-26', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't34', projectId: 'p8', title: '해시태그 전략 수립', desc: '콘텐츠별 해시태그 세트 정리.', tag: '마케팅', priority: 'Low', status: 'todo', date: '2025-10-27', assignee: '김기획', cost: 0, comments: [] },
            { id: 't17', projectId: 'p9', title: '종편 및 사운드 믹싱', desc: 'BGM 저작권 확인 필수, 내레이션 녹음 파일 싱크 맞추기', tag: '편집', priority: 'Medium', status: 'review', date: '2025-11-10', assignee: '김기획', cost: 100, comments: [{id: 'c8', text: '내레이션 볼륨이 조금 작습니다.', author: '오마케', date: '2025-10-26', time: '09:00', target: '김기획'}] },
            { id: 't35', projectId: 'p9', title: '현지 촬영 허가', desc: '지자체 촬영 허가서 수령 및 일정 조율.', tag: '제작', priority: 'High', status: 'inprogress', date: '2025-10-20', assignee: '변PD', cost: 0, comments: [] },
            { id: 't36', projectId: 'p9', title: '인터뷰 섭외 리스트', desc: '지역 전문가 5명 섭외 리스트 확정.', tag: '기획', priority: 'Medium', status: 'todo', date: '2025-10-24', assignee: '김기획', cost: 0, comments: [] },
            { id: 't18', projectId: 'p10', title: '성우 녹음', desc: '신뢰감 있는 목소리 톤', tag: '제작', priority: 'Medium', status: 'done', date: '2025-09-15', assignee: '박개발', cost: 30, comments: [{id: 'c9', text: '임성우님 섭외 완료했습니다.', author: '박개발', date: '2025-09-10', time: '11:00', target: '변PD'}] },
            { id: 't37', projectId: 'p10', title: '튜토리얼 화면 캡처', desc: '앱 주요 플로우 스크린 캡처 정리.', tag: '제작', priority: 'Medium', status: 'done', date: '2025-09-12', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't38', projectId: 'p10', title: '자막 가이드 반영', desc: '접근성 기준에 맞춘 자막 스타일 적용.', tag: '편집', priority: 'Low', status: 'review', date: '2025-09-18', assignee: '박개발', cost: 0, comments: [] },
            { id: 't39', projectId: 'p1', title: '헤어/메이크업 콜시트', desc: '모델별 헤어/메이크업 순서표 작성.', tag: '제작', priority: 'Medium', status: 'todo', date: '2025-10-30', assignee: '변PD', cost: 0, comments: [] },
            { id: 't40', projectId: 'p1', title: '촬영 스케줄 시트 정리', desc: '룩별 컷 분량과 시간 배정 정리.', tag: '기획', priority: 'High', status: 'inprogress', date: '2025-10-29', assignee: '김기획', cost: 0, comments: [] },
            { id: 't41', projectId: 'p2', title: '스태프 콜 타임 확정', desc: '현장 스태프 콜 타임 및 동선 공유.', tag: '제작', priority: 'High', status: 'review', date: '2025-10-28', assignee: '변PD', cost: 0, comments: [] },
            { id: 't42', projectId: 'p2', title: '로케이션 헌팅 리포트', desc: '학교 세트 후보지 촬영 리포트 공유.', tag: '기획', priority: 'Medium', status: 'done', date: '2025-10-18', assignee: '김기획', cost: 0, comments: [] },
            { id: 't43', projectId: 'p3', title: '스튜디오 라이트 테스트', desc: '광고 세트 라이팅 톤 테스트 촬영.', tag: '제작', priority: 'Medium', status: 'review', date: '2025-10-15', assignee: '박개발', cost: 40, comments: [] },
            { id: 't44', projectId: 'p3', title: '콘티 2차 시안 공유', desc: '광고주 피드백 반영 콘티 전달.', tag: '기획', priority: 'High', status: 'inprogress', date: '2025-10-13', assignee: '김기획', cost: 0, comments: [] },
            { id: 't45', projectId: 'p4', title: '캠페인 해시태그 정리', desc: '플랫폼별 해시태그 세트 확정.', tag: '마케팅', priority: 'Low', status: 'done', date: '2025-10-05', assignee: '김기획', cost: 0, comments: [] },
            { id: 't46', projectId: 'p4', title: 'A/B 썸네일 테스트', desc: '썸네일 2종 노출 테스트 진행.', tag: '마케팅', priority: 'Medium', status: 'review', date: '2025-10-11', assignee: '변PD', cost: 0, comments: [] },
            { id: 't47', projectId: 'p5', title: '인터뷰 질문지 확정', desc: '직무별 핵심 질문 정리 및 검수.', tag: '기획', priority: 'High', status: 'done', date: '2025-10-17', assignee: '김기획', cost: 0, comments: [] },
            { id: 't48', projectId: 'p5', title: '편집 컷 분량 정리', desc: '인터뷰 원본 컷 분류 및 타임코드 작성.', tag: '편집', priority: 'Medium', status: 'inprogress', date: '2025-10-27', assignee: '박개발', cost: 0, comments: [] },
            { id: 't49', projectId: 'p6', title: 'BGM 후보 리스트', desc: '회차 분위기에 맞는 BGM 후보 정리.', tag: '편집', priority: 'Low', status: 'todo', date: '2025-10-23', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't50', projectId: 'p6', title: '촬영 동선 체크', desc: '카메라 동선 및 조명 배치 확인.', tag: '제작', priority: 'Medium', status: 'inprogress', date: '2025-10-21', assignee: '변PD', cost: 0, comments: [] },
            { id: 't51', projectId: 'p7', title: '캐릭터 모션 테스트', desc: '리깅 후 기본 모션 테스트 렌더.', tag: '제작', priority: 'High', status: 'inprogress', date: '2025-11-08', assignee: '박개발', cost: 120, comments: [] },
            { id: 't52', projectId: 'p7', title: '트레일러 컷 편집', desc: '30초 하이라이트 컷 편집 1차.', tag: '편집', priority: 'Medium', status: 'todo', date: '2025-11-12', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't53', projectId: 'p8', title: '리뷰 코멘트 반영', desc: '브랜드 피드백 반영하여 색감 조정.', tag: '편집', priority: 'Medium', status: 'inprogress', date: '2025-10-29', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't54', projectId: 'p8', title: 'UGC 촬영 가이드', desc: '인플루언서용 촬영 가이드 제작.', tag: '마케팅', priority: 'Low', status: 'todo', date: '2025-10-30', assignee: '김기획', cost: 0, comments: [] },
            { id: 't55', projectId: 'p9', title: '현장 리허설 진행', desc: '동선 및 인터뷰 리허설 진행.', tag: '제작', priority: 'High', status: 'review', date: '2025-10-22', assignee: '변PD', cost: 0, comments: [] },
            { id: 't56', projectId: 'p9', title: '내레이션 스크립트 1차', desc: '다큐 내레이션 스크립트 초안 작성.', tag: '기획', priority: 'Medium', status: 'todo', date: '2025-10-28', assignee: '김기획', cost: 0, comments: [] },
            { id: 't57', projectId: 'p10', title: 'UI 강조 애니메이션', desc: '핵심 버튼 강조 모션 추가.', tag: '편집', priority: 'Medium', status: 'inprogress', date: '2025-09-20', assignee: '이디자인', cost: 0, comments: [] },
            { id: 't58', projectId: 'p10', title: '튜토리얼 내레이션 원고', desc: '앱 사용법 내레이션 원고 확정.', tag: '기획', priority: 'Low', status: 'done', date: '2025-09-08', assignee: '김기획', cost: 0, comments: [] }
        ];

        const defaultTags = ['기획', '제작', '편집', '디자인', '마케팅'];
        const defaultContacts = [
            { id: 'ct1', name: '최대표', category: '의뢰 고객', company: '(주)스타트업', role: '대표', phone: '010-1234-5678', email: 'ceo@startup.com', fax: '02-123-4567', address: '서울 강남구 테헤란로 123', memo: '주요 클라이언트, 빠른 피드백 선호' },
            { id: 'ct2', name: '김기획', category: '크리에이터', company: '크리에잇', role: '기획팀장', phone: '010-2345-6789', email: 'plan@create.com', fax: '02-555-1234', address: '서울 마포구 성미산로 88', memo: '' },
            { id: 'ct3', name: '이디자인', category: '크리에이터', company: '크리에잇', role: '디자이너', phone: '010-3456-7890', email: 'design@create.com', fax: '02-555-1234', address: '서울 마포구 성미산로 88', memo: '' },
            { id: 'ct4', name: '박개발', category: '크리에이터', company: '프리랜서', role: '개발자', phone: '010-4567-8901', email: 'dev@free.com', fax: '02-987-6543', address: '경기도 성남시 분당구 판교로', memo: '원격 근무 중' },
            { id: 'ct5', name: '홍길동', category: '출연자', company: '모델에이전시', role: '모델', phone: '010-9999-8888', email: 'model@agency.com', fax: '02-888-9999', address: '서울 강남구 압구정로 456', memo: '촬영 스케줄 확인 필요' },
            { id: 'ct6', name: '정소품', category: '장소관계자', company: '스튜디오A', role: '실장', phone: '010-1111-2222', email: 'studio@a.com', fax: '02-333-4444', address: '서울 강남구 논현동 10-1', memo: '주차 공간 협소' },
            { id: 'ct7', name: '강배우', category: '출연자', company: '프리랜서', role: '배우', phone: '010-3333-4444', email: 'actor@kang.com', fax: '-', address: '서울 용산구 이태원로 200', memo: '감정 연기 탁월' },
            { id: 'ct8', name: '윤작가', category: '크리에이터', company: '프리랜서', role: '시나리오 작가', phone: '010-5555-6666', email: 'writer@yoon.com', fax: '-', address: '경기도 고양시 일산동구', memo: '재택 근무 선호' },
            { id: 'ct9', name: '송감독', category: '크리에이터', company: '영상제작소', role: '감독', phone: '010-7777-8888', email: 'director@song.com', fax: '02-777-0000', address: '서울 마포구 합정동 30-5', memo: '영상미 중시' },
            { id: 'ct10', name: '오마케', category: '의뢰 고객', company: '(주)커머스', role: '마케팅 팀장', phone: '010-9999-0000', email: 'mkt@commerce.com', fax: '02-111-2222', address: '서울 구로구 디지털로 50', memo: 'SNS 트렌드 민감' },
            { id: 'ct11', name: '한조명', category: '장소관계자', company: '빛나는조명', role: '대표', phone: '010-1212-3434', email: 'light@shiny.com', fax: '02-222-3333', address: '서울 종로구 청계천로 100', memo: '장비 대여 가능' },
            { id: 'ct12', name: '임성우', category: '출연자', company: '보이스팩토리', role: '성우', phone: '010-5656-7878', email: 'voice@factory.com', fax: '02-565-7878', address: '서울 서초구 반포대로 77', memo: '다양한 목소리 보유' }
        ];

        const STORAGE_KEY_PROJS = 'plug_projects_v7_real_data';
        const STORAGE_KEY_TASKS = 'plug_tasks_v7_real_data'; 
        const STORAGE_KEY_TAGS = 'plug_tags_v1';
        const STORAGE_KEY_CONTACTS = 'plug_contacts_v6_full_data';
        const STORAGE_KEY_LOGIN = 'plug_is_logged_in';
        const STORAGE_KEY_COMPANY = 'plug_company_name';
        const STORAGE_KEY_THEME = 'plug_theme';

        function safeParse(key) {
            try {
                const raw = localStorage.getItem(key);
                if (raw == null) return undefined;
                return JSON.parse(raw);
            } catch (e) {
                return undefined;
            }
        }
        function loadWithFallback(keys, fallback) {
            for (const key of keys) {
                const value = safeParse(key);
                if (value !== undefined) return value;
            }
            return fallback;
        }
        function coerceArray(value, fallback = []) {
            if (Array.isArray(value)) return value;
            if (value && typeof value === 'object') return Object.values(value);
            return fallback;
        }

        let projects = coerceArray(loadWithFallback([STORAGE_KEY_PROJS, 'plug_projects_v3_kr'], defaultProjects), defaultProjects);
        let tasks = coerceArray(loadWithFallback([STORAGE_KEY_TASKS, 'plug_tasks_v5_kr'], defaultTasks), defaultTasks);
        let tags = coerceArray(loadWithFallback([STORAGE_KEY_TAGS], defaultTags), defaultTags);
        let contacts = coerceArray(loadWithFallback([STORAGE_KEY_CONTACTS, 'plug_contacts_v3_category'], defaultContacts), defaultContacts);
        const defaultTaskIds = new Set(defaultTasks.map(t => t.id));
        const existingTaskIds = new Set(tasks.map(t => t.id));
        let didMergeTasks = false;
        defaultTasks.forEach(t => {
            if (!existingTaskIds.has(t.id)) {
                tasks.push(t);
                didMergeTasks = true;
            }
        });
        if (didMergeTasks) localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(tasks));
        let didNormalizeTasks = false;
        tasks.forEach(task => {
            if (!task.createdAt) {
                task.createdAt = task.date || new Date().toLocaleDateString();
                didNormalizeTasks = true;
            }
        });
        if (didNormalizeTasks) localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(tasks));
        let didNormalizeContacts = false;
        contacts.forEach(contact => {
            if (!contact.createdAt) {
                contact.createdAt = new Date().toLocaleDateString();
                didNormalizeContacts = true;
            }
            if (!contact.updatedAt) {
                contact.updatedAt = contact.createdAt;
                didNormalizeContacts = true;
            }
        });
        if (didNormalizeContacts) localStorage.setItem(STORAGE_KEY_CONTACTS, JSON.stringify(contacts));

        let activeProjectId = projects[0]?.id || null;
        let activeView = 'overview'; 
        let chartInstance = null;
        let currentEditTaskId = null;
        let currentEditProjId = null;
        let activeTaskDetailId = null;
        let currentEditContactId = null; 
        let lastMovedTaskId = null;
        
        let activeContactFilter = 'all';
        let currentCalendarDate = new Date();

        function init() {
            applyPreferences();
            setupProjectMoneyInputs();
            const isLoggedIn = localStorage.getItem(STORAGE_KEY_LOGIN);
            if (isLoggedIn === 'true') {
                showApp();
            } else {
                showLogin();
            }
        }

        function setupProjectMoneyInputs() {
            const budgetInput = document.getElementById('projBudget');
            const revenueInput = document.getElementById('projRevenue');
            [budgetInput, revenueInput].forEach(input => {
                if (!input) return;
                input.addEventListener('input', () => formatCommaInput(input));
                input.addEventListener('blur', () => formatCommaInput(input));
            });
        }

        // --- Function Hoisting (Declarations) ---
        function handleLogin(e) {
            e.preventDefault();
            localStorage.setItem(STORAGE_KEY_LOGIN, 'true');
            showApp();
        }

        function handleLogout() {
            localStorage.removeItem(STORAGE_KEY_LOGIN);
            showLogin();
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            switchView('overview');
            renderAll();
        }

        function applyPreferences() {
            const storedCompany = localStorage.getItem(STORAGE_KEY_COMPANY);
            if (storedCompany) updateBrandName(storedCompany);
            updateLoginBrandName(storedCompany || '크리에잇');
            const storedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'dark';
            applyTheme(storedTheme);
        }
        function updateBrandName(name) {
            const el = document.getElementById('brand-name');
            if (el) el.textContent = name || '크리에잇';
        }
        function updateLoginBrandName(name) {
            const el = document.getElementById('login-brand-name');
            if (el) el.textContent = name || '크리에잇';
        }
        function applyTheme(theme) {
            const isLight = theme === 'light';
            document.body.classList.toggle('theme-light', isLight);
        }
        function setThemeFromSelect() {
            const select = document.getElementById('theme-select');
            if (!select) return;
            const theme = select.value;
            localStorage.setItem(STORAGE_KEY_THEME, theme);
            applyTheme(theme);
        }
        function saveCompanyName() {
            const input = document.getElementById('company-name-input');
            if (!input) return;
            const name = input.value.trim();
            localStorage.setItem(STORAGE_KEY_COMPANY, name);
            updateBrandName(name || '크리에잇');
            updateLoginBrandName(name || '크리에잇');
            showToast('회사명이 업데이트되었습니다.');
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY_PROJS, JSON.stringify(projects));
            localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(tasks));
            localStorage.setItem(STORAGE_KEY_TAGS, JSON.stringify(tags));
            localStorage.setItem(STORAGE_KEY_CONTACTS, JSON.stringify(contacts));
        }

        function getActiveProject() { return projects.find(p => p.id === activeProjectId) || projects[0] || {}; }
        function getProjectTasks() { return tasks.filter(t => t.projectId === activeProjectId); }
        
        function switchProject(id) { 
            activeProjectId = id; 
            renderAll(); 
        }

        function showToast(msg) {
            const el = document.getElementById('toast'); document.getElementById('toastMsg').textContent = msg;
            el.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
        function formatMoney(value) {
            const num = Number(value) || 0;
            return `₩${Math.round(num).toLocaleString('ko-KR')}`;
        }
        function formatCommaInput(input) {
            if (!input) return;
            const raw = input.value.replace(/[^\d]/g, '');
            if (!raw) {
                input.value = '';
                return;
            }
            input.value = Number(raw).toLocaleString('ko-KR');
        }
        function parseMoneyInput(value) {
            const raw = String(value || '').replace(/[^\d]/g, '');
            return raw ? parseInt(raw, 10) : 0;
        }
        function getAvatarColor(name) {
            if (name === 'Me' || name === '변PD') return 'bg-indigo-500/20 text-indigo-300';
            return 'bg-gray-700 text-gray-300';
        }
        function openAiAnalysisModal() {
            const modal = document.getElementById('aiAnalysisModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            const loading = document.getElementById('ai-report-loading');
            const content = document.getElementById('ai-report-content');
            if (loading) loading.style.display = 'flex';
            if (content) content.innerHTML = '';

            const project = getActiveProject();
            const projTasks = getProjectTasks();
            const report = generateAiReport(project, projTasks);
            setTimeout(() => {
                if (loading) loading.style.display = 'none';
                if (content) {
                    content.innerHTML = (window.marked ? marked.parse(report) : report.replace(/\n/g, '<br>'));
                }
            }, 400);
        }
        function closeAiAnalysisModal() {
            const modal = document.getElementById('aiAnalysisModal');
            if (modal) modal.classList.add('hidden');
        }
        function generateAiReport(project, list) {
            const total = list.length;
            const done = list.filter(t => t.status === 'done').length;
            const inprogress = list.filter(t => t.status === 'inprogress').length;
            const review = list.filter(t => t.status === 'review').length;
            const todo = list.filter(t => t.status === 'todo').length;
            const budget = Number(project.budget) || 0;
            const used = list.reduce((acc, t) => acc + (Number(t.cost) || 0), 0);
            const remain = Math.max(budget - used, 0);
            const urgent = list.filter(t => {
                if (!t.date) return false;
                const today = new Date(); today.setHours(0,0,0,0);
                const target = new Date(t.date); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                return diff >= 0 && diff <= 3 && t.status !== 'done';
            }).length;

            return [
                `# AI 프로젝트 리포트`,
                ``,
                `**프로젝트**: ${project.title || '미지정'}`,
                `**현황 요약**: 총 ${total}건 / 진행중 ${inprogress} / 검토 ${review} / 완료 ${done} / 대기 ${todo}`,
                `**마감 임박**: ${urgent}건`,
                ``,
                `## 예산`,
                `- 사용 예산: ${formatMoney(used)}`,
                `- 잔여 예산: ${formatMoney(remain)}`,
                ``,
                `## 다음 액션`,
                `- 진행중 업무의 리스크/지연 사유 확인`,
                `- 마감 임박 업무 우선순위 재정렬`,
            ].join('\n');
        }

        function renderAll() { 
            renderHeader(); 
            renderSidebarProjects(); 
            updateTagSelects(); 
            updateContactSelects(); 
            if(activeView === 'overview') renderOverviewDashboard();
            else if(activeView === 'board' || activeView === 'dashboard') { renderDashboard(); renderBoard(); }
            else if(activeView === 'contacts') renderContactsView(); 
            else if(activeView === 'projects') renderAllProjectsView(); 
            else renderBoard();
        }
        
        function switchView(view) { 
            if (view === 'dashboard') view = 'board';
            activeView = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navEl = document.getElementById(`nav-${view}`);
            if (navEl) navEl.classList.add('active');
            
            ['overview', 'board', 'contacts', 'projects'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.classList.add('hidden');
            });
            
            const el = document.getElementById(`view-${view}`); 
            if(el) {
                el.classList.remove('hidden'); 
                el.classList.add('animate-slide-in');
            }
            
            if(view === 'overview') renderOverviewDashboard(); 
            else if(view === 'board') { renderDashboard(); renderBoard(); }
            else if(view === 'contacts') renderContactsView();
            else if(view === 'projects') renderAllProjectsView(); 
            else renderBoard();
            
            renderHeader();
        }

        function renderHeader() {
            if (activeView === 'overview') {
                setText('header-project-title', '모니터링');
                setText('header-client-company', '전체 프로젝트');
                document.getElementById('header-project-meta').innerHTML = '';
                return;
            }
            if (activeView === 'projects') {
                setText('header-project-title', '전체 프로젝트');
                setText('header-client-company', 'Project Overview'); // Restored
                document.getElementById('header-project-meta').innerHTML = '';
                return;
            }
            if (activeView === 'contacts') {
                setText('header-project-title', '인물 관리');
                setText('header-client-company', 'Contacts'); 
                document.getElementById('header-project-meta').innerHTML = '';
                return;
            }

            const p = getActiveProject();
            if(!p.id) return;
            setText('header-project-title', p.title);
            setText('header-client-company', p.clientCompany || '');
            const c = { 'indigo': 'border-indigo-500/20 text-indigo-400 bg-indigo-500/10', 'emerald': 'border-emerald-500/20 text-emerald-400 bg-emerald-500/10', 'rose': 'border-rose-500/20 text-rose-400 bg-rose-500/10', 'amber': 'border-amber-500/20 text-amber-400 bg-amber-500/10' }[p.color] || 'border-indigo-500/20 text-indigo-400 bg-indigo-500/10';
            
            const statusText = p.status === 'inprogress' ? '진행중' : (p.status === 'todo' ? '기획' : p.status);
            
            document.getElementById('header-project-meta').innerHTML = `<span class="px-2 py-0.5 rounded text-xs font-medium border ${c}">${statusText}</span><span class="text-xs text-gray-500">ID: ${p.id}</span>`;
        }
        
        function renderSidebarProjects() {
            const c = document.getElementById('project-list'); c.innerHTML = '';
            projects.forEach(p => {
                const active = p.id === activeProjectId ? 'bg-white/5 text-white' : 'text-gray-400 hover:bg-white/5 hover:text-gray-200';
                const d = document.createElement('div'); 
                d.className = `flex items-center gap-3 px-4 py-2 rounded-lg text-sm cursor-pointer transition-colors ${active}`;
                d.onclick = () => {
                    switchProject(p.id);
                    if (activeView === 'overview') switchView('board');
                };
                d.innerHTML = `<div class="overflow-hidden text-ellipsis whitespace-nowrap">${p.title}</div>`;
                c.appendChild(d);
            });
        }
        
        function updateTagSelects() {
            const modalSelect = document.getElementById('taskTagInput');
            if(modalSelect) modalSelect.innerHTML = tags.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function updateContactSelects() {
             const tlSelect = document.getElementById('timeline-target-select');
             if(tlSelect) {
                 const opts = contacts.map(c => {
                     const info = c.company && c.role ? `${c.company} ${c.role}` : (c.company || c.role || c.info || '');
                     return `<option value="${c.name}">${c.name} (${info})</option>`;
                 }).join('');
                 tlSelect.innerHTML = `<option value="">없음 (단순 기록)</option>` + opts;
             }
        }

        // --- Render Functions (Explicit Declarations) ---

        function renderDashboard() {
            const p = getActiveProject(); const t = getProjectTasks();
            if(!p.id) return;
            setText('dash-proj-title', p.title); setText('dash-proj-id', `ID: ${p.id}`);
            setText('dash-client-company', p.clientCompany || '미지정'); setText('dash-proj-manager', p.manager || '미지정');
            setText('dash-client-name', p.clientName || '-'); setText('dash-client-contact', p.clientContact || '-');
            
            // Financial Logic: Profit = Budget - Cost
            const budget = Number(p.budget) || 0; 
            const used = t.reduce((acc, curr) => acc + (Number(curr.cost) || 0), 0);
            const profit = budget - used;
            const revenue = Number(p.revenue) || 0;

            setText('stat-budget', formatMoney(budget)); 
            setText('stat-revenue', formatMoney(revenue)); 
            setText('stat-inprogress', `${t.filter(x=>x.status==='inprogress').length}건`);
            const today = new Date(); const urgent = t.filter(x => { const d = new Date(x.date); const diff = (d - today) / (1000 * 60 * 60 * 24); return diff >= 0 && diff <= 3 && x.status !== 'done'; }).length;
            setText('stat-urgent', `${urgent}건`);
            
            const smap = { '기획': 'bg-gray-700 text-gray-300', '진행중': 'bg-indigo-500/20 text-indigo-300 border border-indigo-500/30', '완료': 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30', '보류': 'bg-amber-500/20 text-amber-300 border border-amber-500/30', '검토': 'bg-orange-500/20 text-orange-300 border border-orange-500/30' };
            const badgeClass = smap[p.status] || 'bg-gray-700 text-gray-300';
            document.getElementById('dash-status-badge').className = `px-2 py-0.5 rounded text-[10px] font-medium ${badgeClass}`;
            setText('dash-status-badge', p.status);
            
            const ctxCanvas = document.getElementById('financeChart');
            if(ctxCanvas) {
                const ctx = ctxCanvas.getContext('2d'); if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['지출 (Cost)', '순수익 (Profit)'], 
                        datasets: [{ 
                            data: [used, Math.max(profit, 0)], 
                            backgroundColor: ['#f43f5e', '#10b981'], 
                            borderColor: '#1e293b', borderWidth: 2 
                        }] 
                    }, 
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: "'Noto Sans KR', sans-serif" }, padding: 20 } }, tooltip: { callbacks: { label: function(context) { return ' ' + context.label + ': ' + formatMoney(context.raw); } } } }, cutout: '70%' } 
                });
            }
            // Calendar
            const cal = document.getElementById('calendar-grid');
            if(cal) {
                cal.innerHTML = '';
                const viewYear = currentCalendarDate.getFullYear(); const viewMonth = currentCalendarDate.getMonth(); const realToday = new Date();
                setText('calendar-month', `${viewYear}년 ${viewMonth + 1}월`);
                const firstDay = new Date(viewYear, viewMonth, 1).getDay(); const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
                const totalCells = 42; let cellCount = 0;
                for(let i=0; i<firstDay; i++) { const d = document.createElement('div'); d.className = 'calendar-day opacity-30 bg-[#1e293b]/50'; cal.appendChild(d); cellCount++; }
                for(let i=1; i<=daysInMonth; i++) {
                    const d = document.createElement('div'); d.className = 'calendar-day relative hover:bg-slate-800 transition-colors group flex flex-col'; d.style.overflow = 'hidden'; 
                    const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const dayTasks = t.filter(x => x.date === dateStr);
                    let dots = '';
                    dayTasks.slice(0, 3).forEach(dt => {
                    const bgColors = { 'todo': 'bg-gray-600/80', 'inprogress': 'bg-indigo-600/80', 'review': 'bg-amber-600/80', 'done': 'bg-emerald-600/80', 'hold': 'bg-slate-600/80' };
                         const bg = bgColors[dt.status] || 'bg-gray-600/80';
                        dots += `<div class="${bg} text-[9px] text-white px-1.5 py-0.5 rounded mb-0.5 truncate cursor-pointer hover:opacity-100 opacity-90 transition-opacity" onclick="event.stopPropagation(); openTaskDetail('${dt.id}')">${dt.title}</div>`;
                    });
                    if(dayTasks.length > 3) { dots += `<div class="text-[8px] text-gray-500 pl-1">+ ${dayTasks.length - 3} more</div>`; }
                    const isToday = (i === realToday.getDate() && viewMonth === realToday.getMonth() && viewYear === realToday.getFullYear());
                    d.innerHTML = `<div class="text-xs text-gray-500 mb-1 ${isToday ? 'text-indigo-400 font-bold' : ''}">${i}</div><div class="flex-1 w-full flex flex-col">${dots}</div>`;
                    cal.appendChild(d); cellCount++;
                }
                while(cellCount < totalCells) { const d = document.createElement('div'); d.className = 'calendar-day opacity-20 bg-[#1e293b]/30'; cal.appendChild(d); cellCount++; }
            }
        }

        function parseDateValue(value) {
            if (!value) return 0;
            const d = new Date(value);
            if (!Number.isNaN(d.getTime())) return d.getTime();
            const cleaned = value.replace(/[.\s]/g, '-').replace(/-+/g, '-').replace(/-$/g, '');
            const d2 = new Date(cleaned);
            return Number.isNaN(d2.getTime()) ? 0 : d2.getTime();
        }

        function getProjectProgressRaw(project) {
            const projectTasks = tasks.filter(t => t.projectId === project.id);
            if (projectTasks.length > 0) {
            const weights = { todo: 0, inprogress: 50, review: 80, done: 100, hold: 0 };
                return projectTasks.reduce((acc, t) => acc + (weights[t.status] ?? 0), 0) / projectTasks.length;
            }
            const statusWeights = { '기획': 0, '진행중': 50, '검토': 80, '완료': 100, '보류': 0 };
            return statusWeights[project.status] ?? 0;
        }

        function getProjectProgressPercent(project) {
            return Math.round(getProjectProgressRaw(project) / 10) * 10;
        }

        function renderOverviewCalendar() {
            const cal = document.getElementById('overview-calendar-grid');
            if (!cal) return;
            cal.innerHTML = '';
            const viewYear = currentCalendarDate.getFullYear();
            const viewMonth = currentCalendarDate.getMonth();
            const realToday = new Date();
            setText('overview-calendar-month', `${viewYear}년 ${viewMonth + 1}월`);
            const firstDay = new Date(viewYear, viewMonth, 1).getDay();
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const totalCells = 42;
            let cellCount = 0;
            for (let i = 0; i < firstDay; i++) {
                const d = document.createElement('div');
                d.className = 'calendar-day opacity-30 bg-[#1e293b]/50';
                cal.appendChild(d);
                cellCount++;
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const d = document.createElement('div');
                d.className = 'calendar-day relative hover:bg-slate-800 transition-colors group flex flex-col';
                d.style.overflow = 'hidden';
                const dateStr = `${viewYear}-${String(viewMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayTasks = tasks.filter(x => x.date === dateStr);
                let dots = '';
                dayTasks.slice(0, 3).forEach(dt => {
                    const bgColors = { todo: 'bg-gray-600/80', inprogress: 'bg-indigo-600/80', review: 'bg-amber-600/80', done: 'bg-emerald-600/80', hold: 'bg-slate-600/80' };
                    const bg = bgColors[dt.status] || 'bg-gray-600/80';
                    const proj = projects.find(p => p.id === dt.projectId);
                    const label = proj ? `${proj.title} · ${dt.title}` : dt.title;
                    dots += `<div class="${bg} text-[9px] text-white px-1.5 py-0.5 rounded mb-0.5 truncate cursor-pointer hover:opacity-100 opacity-90 transition-opacity" onclick="event.stopPropagation(); switchProject('${dt.projectId}'); openTaskDetail('${dt.id}')">${label}</div>`;
                });
                if (dayTasks.length > 3) {
                    dots += `<div class="text-[8px] text-gray-500 pl-1">+ ${dayTasks.length - 3} more</div>`;
                }
                const isToday = (i === realToday.getDate() && viewMonth === realToday.getMonth() && viewYear === realToday.getFullYear());
                d.innerHTML = `<div class="text-xs text-gray-500 mb-1 ${isToday ? 'text-indigo-400 font-bold' : ''}">${i}</div><div class="flex-1 w-full flex flex-col">${dots}</div>`;
                cal.appendChild(d);
                cellCount++;
            }
            while (cellCount < totalCells) {
                const d = document.createElement('div');
                d.className = 'calendar-day opacity-20 bg-[#1e293b]/30';
                cal.appendChild(d);
                cellCount++;
            }
        }

        function changeOverviewMonth(diff) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + diff);
            renderOverviewDashboard();
        }

        function renderOverviewDashboard() {
            const allTasks = tasks;
            const totalTasks = allTasks.length;
            const doneCount = allTasks.filter(t => t.status === 'done').length;
            const weights = { todo: 0, inprogress: 50, review: 80, done: 100, hold: 0 };
            const totalProgressRaw = totalTasks > 0
                ? allTasks.reduce((acc, t) => acc + (weights[t.status] ?? 0), 0) / totalTasks
                : (projects.length > 0 ? projects.reduce((acc, p) => acc + getProjectProgressRaw(p), 0) / projects.length : 0);
            const totalProgress = Math.round(totalProgressRaw);
            const totalRevenue = projects.reduce((sum, p) => sum + (Number(p.revenue) || 0), 0);
            const progressRevenue = projects.reduce((sum, p) => sum + (Number(p.revenue) || 0) * (getProjectProgressRaw(p) / 100), 0);
            const activeProjects = projects.filter(p => p.status !== '완료').length;
            const lastUpdatedList = [
                ...projects.map(p => p.updatedAt || p.createdAt).filter(Boolean),
                ...contacts.map(c => c.updatedAt || c.createdAt).filter(Boolean)
            ].sort((a, b) => parseDateValue(b) - parseDateValue(a));

            setText('overview-progress-percent', `${totalProgress}%`);
            setText('overview-done-count', doneCount);
            setText('overview-task-count', totalTasks);
            setText('overview-total-revenue', formatMoney(totalRevenue));
            setText('overview-progress-revenue', formatMoney(progressRevenue));
            setText('overview-project-count', `${projects.length}개`);
            setText('overview-active-projects', activeProjects);
            setText('overview-last-updated', lastUpdatedList[0] || '-');

            const progressBar = document.getElementById('overview-progress-bar');
            if (progressBar) progressBar.style.width = `${totalProgress}%`;

            renderOverviewCalendar();

            const projectList = document.getElementById('overview-projects-list');
            if (projectList) {
                projectList.innerHTML = '';
                const sortedProjects = [...projects].sort((a, b) => {
                    const aDate = parseDateValue(a.updatedAt || a.createdAt);
                    const bDate = parseDateValue(b.updatedAt || b.createdAt);
                    return bDate - aDate;
                }).slice(0, 5);
                if (sortedProjects.length === 0) {
                    projectList.innerHTML = '<div class="text-xs text-gray-500">업데이트된 프로젝트가 없습니다.</div>';
                } else {
                    const statusStyles = { '기획': 'text-gray-400 border-gray-600 bg-gray-500/10', '진행중': 'text-indigo-400 border-indigo-500/50 bg-indigo-500/10', '완료': 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10', '보류': 'text-amber-400 border-amber-500/50 bg-amber-500/10', '검토': 'text-orange-400 border-orange-500/50 bg-orange-500/10' };
                    sortedProjects.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between bg-[#0f172a]/50 border border-gray-700/50 rounded-lg p-3 hover:border-indigo-500/50 transition-colors cursor-pointer';
                        item.onclick = () => { switchProject(p.id); switchView('board'); };
                        const progress = getProjectProgressPercent(p);
                        const statusClass = statusStyles[p.status] || 'text-gray-400 border-gray-600 bg-gray-500/10';
                        item.innerHTML = `
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-200 font-semibold">${p.title}</span>
                                <span class="text-xs text-gray-500">업데이트: ${p.updatedAt || p.createdAt || '-'}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-2 py-0.5 rounded text-[10px] border ${statusClass}">${p.status || '-'}</span>
                                <div class="w-16 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs text-gray-400 w-8 text-right">${progress}%</span>
                            </div>
                        `;
                        projectList.appendChild(item);
                    });
                }
            }

            const contactList = document.getElementById('overview-contacts-list');
            if (contactList) {
                contactList.innerHTML = '';
                const sortedContacts = [...contacts].sort((a, b) => {
                    const aDate = parseDateValue(a.updatedAt || a.createdAt);
                    const bDate = parseDateValue(b.updatedAt || b.createdAt);
                    return bDate - aDate;
                }).slice(0, 5);
                if (sortedContacts.length === 0) {
                    contactList.innerHTML = '<div class="text-xs text-gray-500">업데이트된 인물이 없습니다.</div>';
                } else {
                    sortedContacts.forEach(c => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between bg-[#0f172a]/50 border border-gray-700/50 rounded-lg p-3 hover:border-indigo-500/50 transition-colors cursor-pointer';
                        item.onclick = () => openContactDetail(c.id);
                        const infoText = c.company && c.role ? `${c.company} · ${c.role}` : (c.company || c.role || '-');
                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-indigo-500/20 text-indigo-200 flex items-center justify-center text-xs font-bold border border-indigo-500/30">${c.name.substring(0,1)}</div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-200 font-semibold">${c.name}</span>
                                    <span class="text-xs text-gray-500">${infoText}</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 text-right">
                                <div>${c.category || '기타'}</div>
                                <div>업데이트: ${c.updatedAt || c.createdAt || '-'}</div>
                            </div>
                        `;
                        contactList.appendChild(item);
                    });
                }
            }
        }

        function renderAllProjectsView() {
            const tbody = document.getElementById('projects-table-body');
            tbody.innerHTML = '';
            const sortVal = document.getElementById('project-sort-select').value;
            let sortedProjects = [...projects];
            const keyword = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();

            if(sortVal === 'newest') sortedProjects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if(sortVal === 'oldest') sortedProjects.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            if(sortVal === 'deadline') {
                sortedProjects.sort((a, b) => {
                    if(!a.deadline) return 1; if(!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });
            }
            if(sortVal === 'budget') { sortedProjects.sort((a, b) => b.budget - a.budget); }
            if (keyword) {
                sortedProjects = sortedProjects.filter(p => {
                    const hay = [
                        p.title,
                        p.clientCompany,
                        p.clientName,
                        p.manager,
                        p.status
                    ].filter(Boolean).join(' ').toLowerCase();
                    return hay.includes(keyword);
                });
            }

            sortedProjects.forEach(p => {
                const pTasks = tasks.filter(t => t.projectId === p.id);
                const total = pTasks.length;
                const done = pTasks.filter(t => t.status === 'done').length;

                // Progress Calculation (Status-weighted, rounded to nearest 10%)
                let percent = 0;
                if (total > 0) {
                    const weights = { todo: 0, inprogress: 50, review: 80, done: 100, hold: 0 };
                    const rawPercent = pTasks.reduce((acc, t) => acc + (weights[t.status] ?? 0), 0) / total;
                    percent = Math.round(rawPercent / 10) * 10; // Round to nearest 10
                }
                
                let ddayText = '-'; let ddayClass = 'text-gray-500';
                if(p.deadline) {
                    const today = new Date(); today.setHours(0,0,0,0); const target = new Date(p.deadline); target.setHours(0,0,0,0);
                    const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                    if(diff === 0) { ddayText = 'D-Day'; ddayClass = 'text-rose-500 font-bold'; }
                    else if(diff < 0) { ddayText = `D+${Math.abs(diff)}`; ddayClass = 'text-gray-500'; }
                    else { ddayText = `D-${diff}`; if(diff <= 7) ddayClass = 'text-orange-400'; else ddayClass = 'text-gray-400'; }
                }

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors cursor-pointer group';
                tr.onclick = () => { switchProject(p.id); switchView('board'); };
                
                const dotColor = { 'indigo': 'bg-indigo-500', 'emerald': 'bg-emerald-500', 'rose': 'bg-rose-500', 'amber': 'bg-amber-500' }[p.color] || 'bg-gray-500';
                const statusColor = { '기획': 'text-gray-400 border-gray-600 bg-gray-500/10', '진행중': 'text-indigo-400 border-indigo-500/50 bg-indigo-500/10', '완료': 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10', '보류': 'text-amber-400 border-amber-500/50 bg-amber-500/10', '검토': 'text-orange-400 border-orange-500/50 bg-orange-500/10' }[p.status] || 'text-gray-400 border-gray-600';

                const revenue = Number(p.revenue) || 0;

                tr.innerHTML = `
                    <td class="px-6 py-4"><div class="flex items-center gap-3"><span class="font-bold text-gray-200">${p.title}</span></div></td>
                    <td class="px-6 py-4 text-gray-400">${p.clientCompany || '-'}</td>
                    <td class="px-6 py-4"><span class="text-gray-300 font-medium">${p.manager || '-'}</span></td>
                    <td class="px-6 py-4"><div class="flex flex-col"><span class="text-xs ${ddayClass} font-bold">${ddayText}</span><span class="text-[10px] text-gray-500">${p.deadline || ''}</span></div></td>
                    <td class="px-6 py-4"><div class="flex items-center gap-2"><div class="flex-1 w-20 h-1.5 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width: ${percent}%"></div></div><span class="text-xs text-gray-400 w-8 text-right">${percent}%</span></div></td>
                    <td class="px-6 py-4"><div class="flex flex-col text-xs"><span class="text-gray-300">${formatMoney(p.budget || 0)}</span><span class="text-emerald-400">${formatMoney(revenue)}</span></div></td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-0.5 rounded text-xs border ${statusColor}">${p.status}</span></td>
                    <td class="px-6 py-4 text-right"><button onclick="event.stopPropagation(); activeProjectId='${p.id}'; openProjectModal('edit')" class="text-gray-500 hover:text-indigo-400 p-1"><i class="fa-solid fa-pen-to-square"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderBoard() {
            const containers = { 'todo': document.getElementById('todo-container'), 'inprogress': document.getElementById('inprogress-container'), 'review': document.getElementById('review-container'), 'done': document.getElementById('done-container'), 'hold': document.getElementById('hold-container') };
            const counts = { 'todo': document.getElementById('count-todo'), 'inprogress': document.getElementById('count-inprogress'), 'review': document.getElementById('count-review'), 'done': document.getElementById('count-done'), 'hold': document.getElementById('count-hold') };
            Object.values(containers).forEach(el => { if(el) el.innerHTML = ''; });
            let countData = { todo: 0, inprogress: 0, review: 0, done: 0, hold: 0 };
            const projTasks = getProjectTasks();
            const keyword = document.getElementById('searchInput').value.toLowerCase();

            projTasks.forEach(task => {
                if (keyword) {
                    const hay = [
                        task.title,
                        task.desc,
                        task.tag,
                        task.assignee
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!hay.includes(keyword)) return;
                }
                const card = createCard(task);
                if (containers[task.status]) { containers[task.status].appendChild(card); countData[task.status]++; }
            });
            Object.keys(countData).forEach(key => { if(counts[key]) counts[key].textContent = countData[key]; });
            updateBoardProgress(projTasks);
            if (lastMovedTaskId) lastMovedTaskId = null;
        }
        function updateBoardProgress(list) {
            const bar = document.getElementById('board-progress-bar');
            const label = document.getElementById('board-progress-percent');
            const countEl = document.getElementById('board-progress-count');
            const totalEl = document.getElementById('board-progress-total');
            if (!bar || !label || !countEl || !totalEl) return;
            if (!list || list.length === 0) {
                bar.style.width = '0%';
                label.textContent = '0';
                countEl.textContent = '0';
                totalEl.textContent = '0';
                return;
            }
            const doneCount = list.filter(t => t.status === 'done').length;
            countEl.textContent = String(doneCount);
            totalEl.textContent = String(list.length);
            const weights = { todo: 0, inprogress: 50, review: 80, done: 100, hold: 0 };
            const rawPercent = list.reduce((acc, t) => acc + (weights[t.status] ?? 0), 0) / list.length;
            const percent = Math.round(rawPercent / 10) * 10;
            bar.style.width = `${percent}%`;
            label.textContent = String(percent);
        }
        function allowDrop(ev) {
            ev.preventDefault();
            const zone = ev.currentTarget;
            if (zone) zone.classList.add('drag-over');
        }
        function dragLeave(ev) {
            const zone = ev.currentTarget;
            if (zone) zone.classList.remove('drag-over');
        }
        function drop(ev, status) {
            ev.preventDefault();
            const zone = ev.currentTarget;
            if (zone) {
                zone.classList.remove('drag-over');
                zone.classList.add('drop-flash');
                setTimeout(() => zone.classList.remove('drop-flash'), 350);
            }
            const taskId = ev.dataTransfer.getData('text/plain');
            if (!taskId) return;
            const idx = tasks.findIndex(t => t.id === taskId);
            if (idx === -1) return;
            tasks[idx].status = status;
            lastMovedTaskId = taskId;
            saveData();
            renderBoard();
        }

        function createCard(task) {
            const div = document.createElement('div');
            const priorityColors = { 'High': 'border-l-4 border-l-rose-500', 'Medium': 'border-l-4 border-l-orange-500', 'Low': 'border-l-4 border-l-blue-500' };
            const priorityClass = priorityColors[task.priority] || 'border-l-4 border-l-gray-600';
            const movedClass = task.id === lastMovedTaskId ? 'animate-slide-in' : '';
            div.className = `task-card p-4 rounded-lg shadow-sm group relative ${priorityClass} ${movedClass}`;
            div.draggable = true; div.id = task.id;
            div.onclick = (e) => { if(!e.target.closest('button')) openTaskDetail(task.id); };
            const today = new Date(); today.setHours(0,0,0,0); const target = new Date(task.date); target.setHours(0,0,0,0);
            const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            let dDay = diffDays === 0 ? 'D-Day' : (diffDays < 0 ? `D+${Math.abs(diffDays)}` : `D-${diffDays}`);
            let dDayClass = (diffDays <= 3 && diffDays >= 0) ? 'text-red-400 font-bold' : 'text-gray-500';
            const assigneeName = task.assignee === 'Me' ? '변PD' : task.assignee;
            const ac = getAvatarColor(task.assignee);
            div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', task.id); div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); document.querySelectorAll('.column-drop-zone').forEach(z => z.classList.remove('drag-over')); });
            const costValue = Number(task.cost) || 0;
            const costBadge = costValue > 0 ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-700 text-emerald-400">${formatMoney(costValue)}</span>` : '';
            div.innerHTML = `<div class="flex justify-between items-start mb-2"><div class="flex gap-1"><span class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-700 text-gray-400">${task.tag}</span>${costBadge}</div><button onclick="deleteTask('${task.id}', event)" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 p-1"><i class="fa-solid fa-trash-can"></i></button></div><h4 class="font-bold text-gray-200 mb-1 text-sm leading-tight">${task.title}</h4><div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-700/50"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full flex items-center justify-center text-[9px] font-bold border border-white/10 ${ac}">${assigneeName.substring(0,1)}</div></div><span class="text-[10px] ${dDayClass}"><i class="fa-regular fa-clock mr-1"></i>${dDay}</span></div>`;
            return div;
        }

        // --- Other Window attached functions ---
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            const companyInput = document.getElementById('company-name-input');
            if (companyInput) companyInput.value = localStorage.getItem(STORAGE_KEY_COMPANY) || '크리에잇';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) themeSelect.value = localStorage.getItem(STORAGE_KEY_THEME) || 'dark';
            renderSettingsTags();
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); renderAll(); }
        function openProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); }
        function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            if (!menu) return;
            menu.classList.toggle('hidden');
        }
        function openAccountModal() {
            const modal = document.getElementById('accountModal');
            if (modal) modal.classList.remove('hidden');
            const menu = document.getElementById('profile-menu');
            if (menu) menu.classList.add('hidden');
        }
        function closeAccountModal() { document.getElementById('accountModal').classList.add('hidden'); }
        function saveAccountSettings() {
            closeAccountModal();
            showToast('계정 정보가 저장되었습니다.');
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profile-menu');
            const card = document.getElementById('profile-card');
            if (!menu || !card) return;
            if (menu.classList.contains('hidden')) return;
            if (menu.contains(e.target) || card.contains(e.target)) return;
            menu.classList.add('hidden');
        });
        function renderSettingsTags() {
            const c = document.getElementById('settings-tag-list');
            if (!c) return;
            c.innerHTML = '';
            tags.forEach((t, idx) => {
                const d = document.createElement('div');
                d.className = 'flex items-center justify-between bg-[#0f172a] p-2 rounded border border-gray-700';
                d.innerHTML = `<span class="text-sm text-gray-300">${t}</span><button data-tag="${t}" onclick="requestTagDelete(this.dataset.tag)" class="text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>`;
                c.appendChild(d);
            });
        }
        function renderTagManagerTags() {
            const c = document.getElementById('tag-manager-list');
            if (!c) return;
            c.innerHTML = '';
            tags.forEach((t) => {
                const usedCount = tasks.filter(task => task.tag === t).length;
                const d = document.createElement('div');
                d.className = 'flex items-center justify-between bg-[#0f172a] p-2 rounded border border-gray-700';
                d.innerHTML = `<div class="flex items-center gap-2"><span class="text-sm text-gray-300">${t}</span><span class="text-[10px] text-gray-500">${usedCount}개 사용중</span></div><button data-tag="${t}" onclick="requestTagDelete(this.dataset.tag)" class="text-gray-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>`;
                c.appendChild(d);
            });
        }
        function addTagValue(value) {
            const v = value.trim();
            if (!v || tags.includes(v)) return;
            tags.push(v);
            saveData();
            renderSettingsTags();
            renderTagManagerTags();
            updateTagSelects();
        }
        function addNewTag() {
            const i = document.getElementById('new-tag-input');
            addTagValue(i.value);
            i.value = '';
        }
        function addTagFromManager() {
            const i = document.getElementById('tag-manager-input');
            addTagValue(i.value);
            i.value = '';
        }
        let pendingTagDelete = null;
        function deleteTag(idx) { requestTagDelete(tags[idx]); }
        function requestTagDelete(tagName) {
            if (!tagName) return;
            pendingTagDelete = tagName;
            const usedCount = tasks.filter(task => task.tag === tagName).length;
            const message = usedCount > 0
                ? `이 태그는 ${usedCount}개의 업무에 사용 중입니다. 삭제하면 데이터가 손상될 수 있습니다.`
                : '이 태그를 삭제하시겠습니까?';
            const msgEl = document.getElementById('tag-delete-message');
            if (msgEl) msgEl.textContent = message;
            const modal = document.getElementById('tagDeleteModal');
            if (modal) modal.classList.remove('hidden');
        }
        function closeTagDeleteModal() {
            const modal = document.getElementById('tagDeleteModal');
            if (modal) modal.classList.add('hidden');
            pendingTagDelete = null;
        }
        function confirmDeleteTag() {
            if (!pendingTagDelete) return;
            const tagName = pendingTagDelete;
            pendingTagDelete = null;
            const modal = document.getElementById('tagDeleteModal');
            if (modal) modal.classList.add('hidden');
            tags = tags.filter(t => t !== tagName);
            tasks.forEach(task => { if (task.tag === tagName) task.tag = ''; });
            saveData();
            renderSettingsTags();
            renderTagManagerTags();
            updateTagSelects();
            renderAll();
        }
        function openTagManagerModal() {
            renderTagManagerTags();
            const modal = document.getElementById('tagManagerModal');
            if (modal) modal.classList.remove('hidden');
        }
        function closeTagManagerModal() {
            const modal = document.getElementById('tagManagerModal');
            if (modal) modal.classList.add('hidden');
        }
        function addNewContact() { const n = document.getElementById('new-contact-name').value.trim(); const info = document.getElementById('new-contact-info').value.trim(); if(n) { contacts.push({id:'ct'+Date.now(), name:n, info:info}); saveData(); renderSettingsContacts(); document.getElementById('new-contact-name').value=''; document.getElementById('new-contact-info').value=''; } }
        function deleteContact(idx) { contacts.splice(idx, 1); saveData(); renderSettingsContacts(); }
        function editFromDetail() { if (!activeTaskDetailId) return; openTaskModal('edit', activeTaskDetailId); }
        function deleteFromDetail() { if(activeTaskDetailId) { deleteTask(activeTaskDetailId); closeTaskDetail(); } }
        function addSubtask() {
            const input = document.getElementById('new-subtask-input'); const text = input.value.trim();
            if (!text || !activeTaskDetailId) return;
            const task = tasks.find(t => t.id === activeTaskDetailId); if (!task.subtasks) task.subtasks = [];
            task.subtasks.push({ id: 's' + Date.now(), text: text, done: false }); input.value = ''; saveData(); renderSubtasks(activeTaskDetailId);
        }
        function toggleSubtask(taskId, subId) {
            const task = tasks.find(t => t.id === taskId); const sub = task.subtasks.find(s => s.id === subId);
            if (sub) { sub.done = !sub.done; saveData(); renderSubtasks(taskId); }
        }
        function deleteSubtask(taskId, subId) {
            const task = tasks.find(t => t.id === taskId); task.subtasks = task.subtasks.filter(s => s.id !== subId); saveData(); renderSubtasks(taskId);
        }
        function renderSubtasks(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const container = document.getElementById('detail-subtask-list');
            if (!container || !task) return;
            container.innerHTML = '';

            const list = task.subtasks || [];
            const doneCount = list.filter(s => s.done).length;
            setText('detail-subtask-count', `${doneCount}/${list.length}`);

            list.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-2 hover:bg-white/5 rounded group';
                div.innerHTML = `
                    <label class="custom-checkbox cursor-pointer relative flex items-center">
                        <input type="checkbox" class="sr-only" ${sub.done ? 'checked' : ''} onchange="toggleSubtask('${taskId}', '${sub.id}')">
                        <div class="w-4 h-4 border-2 border-gray-500 rounded flex items-center justify-center transition-colors">
                            <svg class="w-2.5 h-2.5 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </label>
                    <span class="text-sm text-gray-300 flex-1 ${sub.done ? 'line-through text-gray-500' : ''}">${sub.text}</span>
                    <button onclick="deleteSubtask('${taskId}', '${sub.id}')" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-xmark"></i></button>
                `;
                container.appendChild(div);
            });
        }
        function openContactDetailByName(name) {
            const contact = contacts.find(c => c.name === name);
            if (contact) { openContactDetail(contact.id); } else { showToast(`'${name}' 인물 정보를 찾을 수 없습니다.`); }
        }
        function addComment() {
            const input = document.getElementById('new-comment-input'); const targetSelect = document.getElementById('timeline-target-select'); const text = input.value.trim();
            if (!text || !activeTaskDetailId) return;
            const task = tasks.find(t => t.id === activeTaskDetailId); if (!task.comments) task.comments = [];
            const now = new Date(); const dateStr = now.toISOString().split('T')[0]; const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            task.comments.push({ id: 'c' + Date.now(), text: text, author: 'Me', date: dateStr, time: timeStr, target: targetSelect.value });
            input.value = ''; targetSelect.value = ''; saveData(); renderComments(activeTaskDetailId);
        }
        function filterContacts(category) {
            activeContactFilter = category;
            document.querySelectorAll('.filter-tab').forEach(btn => {
                if(btn.dataset.filter === category) btn.classList.add('active'); else btn.classList.remove('active');
            });
            renderContactsView();
        }
        function renderContactsView() {
            const grid = document.getElementById('contacts-grid');
            if (!grid) return;
            grid.innerHTML = '';
            const keyword = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();

            const filteredContacts = activeContactFilter === 'all'
                ? contacts
                : contacts.filter(c => (c.category || '기타') === activeContactFilter);
            const searchedContacts = keyword
                ? filteredContacts.filter(c => {
                    const hay = [
                        c.name,
                        c.company,
                        c.role,
                        c.phone,
                        c.email
                    ].filter(Boolean).join(' ').toLowerCase();
                    return hay.includes(keyword);
                })
                : filteredContacts;

            if (searchedContacts.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">해당 카테고리의 인물이 없습니다.</div>`;
                return;
            }

            searchedContacts.forEach(c => {
                const card = document.createElement('div');
                card.className = 'contact-card p-4 rounded-lg flex flex-col items-center text-center relative group justify-center min-h-[140px] cursor-pointer';
                card.onclick = () => openContactDetail(c.id);

                const infoText = c.company && c.role ? `${c.company} | ${c.role}` : (c.company || c.role || '-');
                const catBadge = c.category ? `<span class="absolute top-2 left-2 bg-gray-700 text-[9px] text-gray-300 px-1.5 py-0.5 rounded-full">${c.category}</span>` : '';

                card.innerHTML = `
                    ${catBadge}
                    <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); openContactModal('edit', '${c.id}')" class="text-gray-500 hover:text-indigo-400" title="수정">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteContactById('${c.id}')" class="text-gray-500 hover:text-red-400" title="삭제">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                    <h3 class="text-base font-bold text-gray-100 mb-0.5 mt-6">${c.name}</h3>
                    <p class="text-xs text-indigo-400 font-medium mb-3">${infoText}</p>
                    <div class="w-full mt-auto">
                        <div class="bg-[#0f172a] rounded p-1.5 text-[11px] text-gray-400 flex items-center gap-2 justify-center">
                            <i class="fa-solid fa-phone text-gray-500"></i> ${c.phone || '-'}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        function openContactDetail(id) {
            const contact = contacts.find(c => c.id === id); if (!contact) return;
            currentEditContactId = id; 
            document.getElementById('contactDetailModal').classList.remove('hidden');
            setText('detail-contact-name', contact.name);
            setText('detail-contact-category', contact.category || '기타');
            setText('detail-contact-info', (contact.company && contact.role ? `${contact.company} | ${contact.role}` : (contact.company || contact.role || '-')));
            setText('detail-contact-phone', contact.phone || '-'); setText('detail-contact-email', contact.email || '-');
            setText('detail-contact-fax', contact.fax || '-'); setText('detail-contact-address', contact.address || '-');
            setText('detail-contact-memo', contact.memo || '-');
            const avatarEl = document.getElementById('detail-contact-avatar'); avatarEl.textContent = contact.name.substring(0,1);
            
            const projContainer = document.getElementById('detail-contact-projects'); projContainer.innerHTML = '';
            
            let relatedProjs = projects.filter(p => (p.manager && p.manager === contact.name) || (p.clientName && p.clientName === contact.name));
            const mentionedTasks = tasks.filter(t => t.comments && t.comments.some(com => com.target === contact.name));
            
            if (relatedProjs.length > 0 || mentionedTasks.length > 0) {
                relatedProjs.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-[#0f172a] p-2 rounded border border-gray-700/50 hover:border-indigo-500/50 transition-colors cursor-pointer mb-2';
                    div.onclick = () => { closeContactDetail(); switchProject(p.id); switchView('board'); };
                    let roleBadge = '';
                    if(p.manager === contact.name) roleBadge += '<span class="text-[10px] bg-indigo-500/20 text-indigo-300 px-1 rounded ml-1">담당자</span>';
                    if(p.clientName === contact.name) roleBadge += '<span class="text-[10px] bg-emerald-500/20 text-emerald-300 px-1 rounded ml-1">클라이언트</span>';
                    div.innerHTML = `<span class="text-sm text-gray-200 font-medium truncate flex-1">${p.title} ${roleBadge}</span><i class="fa-solid fa-chevron-right text-xs text-gray-500"></i>`;
                    projContainer.appendChild(div);
                });

                mentionedTasks.forEach(t => {
                     const p = projects.find(proj => proj.id === t.projectId);
                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between bg-[#0f172a]/50 p-2 rounded border border-amber-900/30 hover:border-amber-500/50 transition-colors cursor-pointer mb-1';
                     div.onclick = () => { 
                         closeContactDetail(); 
                         switchProject(t.projectId); 
                         switchView('board'); 
                         openTaskDetail(t.id); 
                     };
                     div.innerHTML = `<div class="flex flex-col overflow-hidden"><span class="text-xs text-amber-500 font-bold mb-0.5">@업무참조</span><span class="text-sm text-gray-300 truncate">${t.title}</span><span class="text-[10px] text-gray-500 truncate">${p ? p.title : '삭제된 프로젝트'}</span></div><i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-500"></i>`;
                     projContainer.appendChild(div);
                });

            } else { projContainer.innerHTML = '<p class="text-xs text-gray-500">연관된 프로젝트나 업무가 없습니다.</p>'; }
        }
        function closeContactDetail() { document.getElementById('contactDetailModal').classList.add('hidden'); }
        function editContactFromDetail() { if(currentEditContactId) openContactModal('edit', currentEditContactId); }
        function openContactModal(mode, id=null) { 
             const modal = document.getElementById('contactModal'); const title = modal.querySelector('h3'); const btn = modal.querySelector('button[type="submit"]');
             modal.classList.remove('hidden');
             if(mode === 'edit' && id) {
                 currentEditContactId = id; const c = contacts.find(x => x.id === id);
                 if(c) {
                     document.getElementById('contact-name').value = c.name; document.getElementById('contact-category').value = c.category || '기타';
                     document.getElementById('contact-company').value = c.company || ''; document.getElementById('contact-role').value = c.role || '';
                     document.getElementById('contact-phone').value = c.phone || ''; document.getElementById('contact-email').value = c.email || '';
                     document.getElementById('contact-fax').value = c.fax || ''; document.getElementById('contact-address').value = c.address || '';
                     document.getElementById('contact-memo').value = c.memo || ''; title.textContent = '인물 정보 수정'; btn.textContent = '수정 완료';
                 }
             } else {
                 currentEditContactId = null; title.textContent = '인물 추가'; btn.textContent = '추가';
                 document.getElementById('contact-name').value=''; document.getElementById('contact-category').value='기타'; document.getElementById('contact-company').value='';
                 document.getElementById('contact-role').value=''; document.getElementById('contact-phone').value=''; document.getElementById('contact-email').value='';
                 document.getElementById('contact-fax').value=''; document.getElementById('contact-address').value=''; document.getElementById('contact-memo').value='';
             }
        }
        function closeContactModal() { document.getElementById('contactModal').classList.add('hidden'); }
        function handleContactSubmit(e) {
            e.preventDefault();
            const n = document.getElementById('contact-name').value.trim();
            const now = new Date().toLocaleDateString();
            const data = {
                name: n, category: document.getElementById('contact-category').value, company: document.getElementById('contact-company').value.trim(), role: document.getElementById('contact-role').value.trim(),
                phone: document.getElementById('contact-phone').value.trim(), email: document.getElementById('contact-email').value.trim(), fax: document.getElementById('contact-fax').value.trim(),
                address: document.getElementById('contact-address').value.trim(), memo: document.getElementById('contact-memo').value.trim(),
            };
            if(n) {
                if(currentEditContactId && contacts.find(c => c.id === currentEditContactId)) {
                    const idx = contacts.findIndex(c => c.id === currentEditContactId); contacts[idx] = { ...contacts[idx], ...data, updatedAt: now }; showToast('인물 정보가 수정되었습니다.');
                    if(!document.getElementById('contactDetailModal').classList.contains('hidden')) openContactDetail(currentEditContactId);
                } else { contacts.push({ id:'ct'+Date.now(), createdAt: now, updatedAt: now, ...data }); showToast('새 인물이 추가되었습니다.'); }
                saveData(); renderContactsView(); updateContactSelects(); closeContactModal();
            }
        }
        function deleteContactById(id) { if(confirm('이 연락처를 삭제하시겠습니까?')) { contacts = contacts.filter(c => c.id !== id); saveData(); renderContactsView(); updateContactSelects(); } }
        function openTaskModal(mode, id=null) {
            document.getElementById('taskModal').classList.remove('hidden'); const titleEl = document.getElementById('modalTitle'); updateTagSelects(); 
            if (mode === 'edit' && id) {
                currentEditTaskId = id; titleEl.textContent = '업무 수정'; const t = tasks.find(t => t.id === id);
                document.getElementById('taskTitle').value = t.title; document.getElementById('taskDescInput').value = t.desc; document.getElementById('taskDateInput').value = t.date;
                document.getElementById('taskAssigneeInput').value = t.assignee; document.getElementById('taskPriorityInput').value = t.priority;
                const tagOpt = Array.from(document.getElementById('taskTagInput').options).find(o => o.value === t.tag);
                if(tagOpt) document.getElementById('taskTagInput').value = t.tag; document.getElementById('taskCostInput').value = t.cost || 0;
                document.getElementById('taskDateNone').checked = !t.date;
                toggleTaskDateNone(!t.date);
            } else {
                currentEditTaskId = null; titleEl.textContent = '새 업무 추가'; document.getElementById('addTaskForm').reset(); document.getElementById('taskDateInput').valueAsDate = new Date();
                document.getElementById('taskDateNone').checked = false;
                toggleTaskDateNone(false);
            }
        }
        function toggleTaskDateNone(isNone) {
            const dateInput = document.getElementById('taskDateInput');
            dateInput.disabled = isNone;
            if (isNone) dateInput.value = '';
            dateInput.classList.toggle('opacity-50', isNone);
        }
        function closeTaskModal() { document.getElementById('taskModal').classList.add('hidden'); }
        function handleTaskSubmit(e) {
            e.preventDefault();
            if(!activeProjectId) { if(projects.length > 0) activeProjectId = projects[0].id; else { showToast("프로젝트를 먼저 생성해주세요!"); return; } }
            const formData = {
                title: document.getElementById('taskTitle').value, desc: document.getElementById('taskDescInput').value, date: document.getElementById('taskDateNone').checked ? '' : document.getElementById('taskDateInput').value,
                tag: document.getElementById('taskTagInput').value, priority: document.getElementById('taskPriorityInput').value, assignee: document.getElementById('taskAssigneeInput').value,
                cost: parseInt(document.getElementById('taskCostInput').value, 10) || 0
            };
            if (currentEditTaskId) {
                const idx = tasks.findIndex(t => t.id === currentEditTaskId); tasks[idx] = { ...tasks[idx], ...formData };
                if (activeTaskDetailId === currentEditTaskId) openTaskDetail(currentEditTaskId); 
            } else {
                tasks.push({ id: 't' + Date.now(), projectId: activeProjectId, status: 'todo', subtasks: [], comments: [], customFields: [], attachments: [], createdAt: new Date().toLocaleDateString(), ...formData });
                document.getElementById('searchInput').value = '';
            }
            saveData(); renderAll(); closeTaskModal(); showToast('저장되었습니다.');
        }
        function deleteTask(id, e) { if(e) e.stopPropagation(); if(confirm('삭제하시겠습니까?')) { tasks = tasks.filter(t => t.id !== id); saveData(); renderAll(); } }
        function openTaskDetail(id) {
            activeTaskDetailId = id;
            const task = tasks.find(t => t.id === id);
            const project = getActiveProject();
            if (!task) return;

            document.getElementById('taskDetailModal').classList.remove('hidden');
            setText('detail-project-title', project.title || '프로젝트');
            setText('detail-task-id', task.id);
            setText('detail-title', task.title);
            const descEl = document.getElementById('detail-desc');
            if (descEl) descEl.value = task.desc || '';
            setText('detail-created-at', task.createdAt || '-');

            const statusEl = document.getElementById('detail-status');
            if (statusEl) statusEl.value = task.status;
            const assigneeNameEl = document.getElementById('detail-assignee-name');
            if (assigneeNameEl) {
                assigneeNameEl.textContent = task.assignee ? (task.assignee === 'Me' ? '변PD' : task.assignee) : '-';
            }
            const priorityEl = document.getElementById('detail-priority');
            if (priorityEl) priorityEl.value = task.priority;
            const dateEl = document.getElementById('detail-date');
            if (dateEl) dateEl.value = task.date || '';
            const costEl = document.getElementById('detail-cost');
            if (costEl) costEl.value = task.cost || 0;

            const tagEl = document.getElementById('detail-tag');
            if (tagEl) tagEl.textContent = task.tag || '-';

            const avatarEl = document.getElementById('detail-assignee-avatar');
            if (avatarEl) {
                const authorName = task.assignee === 'Me' ? '변PD' : task.assignee;
                avatarEl.textContent = authorName.substring(0,1);
                avatarEl.className = `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${getAvatarColor(task.assignee)}`;
            }

            renderComments(id);
            renderCustomFields(id);
            renderAttachments(id);
            switchTaskTab('details');
            updateContactSelects();
        }
        function closeTaskDetail() {
            document.getElementById('taskDetailModal').classList.add('hidden');
            activeTaskDetailId = null;
        }
        function updateTaskMeta(field, value) {
            if (!activeTaskDetailId) return;
            const idx = tasks.findIndex(t => t.id === activeTaskDetailId);
            if (idx > -1) {
                if (field === 'cost') {
                    tasks[idx][field] = parseInt(value, 10) || 0;
                } else {
                    tasks[idx][field] = value;
                }
                saveData();
                renderBoard();
            }
        }
        function updateTaskDesc(value) {
            if (!activeTaskDetailId) return;
            const idx = tasks.findIndex(t => t.id === activeTaskDetailId);
            if (idx > -1) {
                tasks[idx].desc = value;
                saveData();
            }
        }
        function handleDescKeydown(e) {
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'a') {
                e.preventDefault();
                e.target.select();
            }
        }
        function switchTaskTab(tab) {
            const details = document.getElementById('task-tab-details');
            const attachments = document.getElementById('task-tab-attachments');
            const btnDetails = document.getElementById('task-tab-btn-details');
            const btnAttachments = document.getElementById('task-tab-btn-attachments');
            if (!details || !attachments || !btnDetails || !btnAttachments) return;
            details.classList.toggle('hidden', tab !== 'details');
            attachments.classList.toggle('hidden', tab !== 'attachments');
            btnDetails.classList.toggle('active', tab === 'details');
            btnAttachments.classList.toggle('active', tab === 'attachments');
        }
        function handleAttachmentUpload(e) {
            if (!activeTaskDetailId) return;
            const files = Array.from(e.target.files || []);
            if (files.length === 0) return;
            const task = tasks.find(t => t.id === activeTaskDetailId);
            if (!task) return;
            if (!task.attachments) task.attachments = [];
            let pending = files.length;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = () => {
                    task.attachments.push({
                        id: 'att' + Date.now() + Math.random().toString(16).slice(2),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        dataUrl: reader.result
                    });
                    pending -= 1;
                    if (pending === 0) {
                        saveData();
                        renderAttachments(activeTaskDetailId);
                    }
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        }
        function removeAttachment(id) {
            const task = tasks.find(t => t.id === activeTaskDetailId);
            if (!task || !task.attachments) return;
            task.attachments = task.attachments.filter(a => a.id !== id);
            saveData();
            renderAttachments(activeTaskDetailId);
        }
        function renderAttachments(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const container = document.getElementById('attachment-list');
            if (!container || !task) return;
            container.innerHTML = '';
            const list = task.attachments || [];
            if (list.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500">첨부된 파일이 없습니다.</div>';
                return;
            }
            list.forEach(att => {
                const sizeKb = Math.max(1, Math.round(att.size / 1024));
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between bg-[#0f172a]/60 border border-gray-700/50 rounded p-2';
                row.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fa-regular fa-file text-gray-500"></i>
                        <div>
                            <div class="text-xs text-gray-200">${att.name}</div>
                            <div class="text-[10px] text-gray-500">${sizeKb}KB</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a class="text-xs text-indigo-400 hover:text-indigo-300" href="${att.dataUrl}" download="${att.name}">다운로드</a>
                        <button class="text-xs text-red-400 hover:text-red-300" onclick="removeAttachment('${att.id}')">삭제</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }
        function renderComments(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const container = document.getElementById('detail-comment-list');
            if (!container || !task) return;
            container.innerHTML = '';

            const list = task.comments || [];
            if (list.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic">기록이 없습니다.</p>';
                return;
            }

            list.forEach(com => {
                const div = document.createElement('div');
                div.className = 'flex gap-3 relative';
                const avatarColor = getAvatarColor(com.author);
                const targetBadge = com.target ? `<span class="bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded text-[10px] ml-2"><i class="fa-solid fa-arrow-right mr-1"></i>${com.target}</span>` : '';

                div.innerHTML = `
                    <div class="flex flex-col items-center">
                         <div class="w-8 h-8 rounded-full ${avatarColor} flex-shrink-0 flex items-center justify-center text-[10px] font-bold border border-white/10 z-10">${com.author === 'Me' ? '변PD' : com.author.substring(0,1)}</div>
                         <div class="w-px bg-gray-700 h-full absolute top-8 -z-0"></div>
                    </div>
                    <div class="bg-[#1e293b] rounded-lg p-3 border border-gray-700/50 flex-1 mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center">
                                <span class="text-xs font-bold text-gray-300">${com.author === 'Me' ? '변PD' : com.author}</span>
                                ${targetBadge}
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-gray-400">${com.date || ''}</div>
                                <div class="text-[10px] text-gray-500">${com.time || ''}</div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-300 leading-snug whitespace-pre-wrap">${com.text}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function openCustomFieldModal() {
            const modal = document.getElementById('customFieldModal');
            if (!modal) return;
            document.getElementById('custom-field-label').value = '';
            document.getElementById('custom-field-type').value = 'text';
            document.getElementById('custom-field-options').value = '';
            toggleCustomFieldOptions();
            modal.classList.remove('hidden');
        }
        function closeCustomFieldModal() { document.getElementById('customFieldModal').classList.add('hidden'); }
        function toggleCustomFieldOptions() {
            const type = document.getElementById('custom-field-type').value;
            const wrap = document.getElementById('custom-field-options-wrap');
            if (wrap) wrap.classList.toggle('hidden', !(type === 'single' || type === 'multi'));
        }
        function handleAddCustomField() {
            if (!activeTaskDetailId) return;
            const label = document.getElementById('custom-field-label').value.trim();
            const type = document.getElementById('custom-field-type').value;
            const optionsRaw = document.getElementById('custom-field-options').value.trim();
            if (!label) return;
            const task = tasks.find(t => t.id === activeTaskDetailId);
            if (!task) return;
            if (!task.customFields) task.customFields = [];
            const field = { id: 'cf' + Date.now(), label, type };
            if (type === 'single' || type === 'multi') {
                field.options = optionsRaw ? optionsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
                field.value = type === 'multi' ? [] : '';
            } else if (type === 'boolean') {
                field.value = false;
            } else {
                field.value = '';
            }
            task.customFields.push(field);
            saveData();
            renderCustomFields(activeTaskDetailId);
            closeCustomFieldModal();
        }
        function updateCustomFieldValue(fieldId, value) {
            const task = tasks.find(t => t.id === activeTaskDetailId);
            if (!task || !task.customFields) return;
            const field = task.customFields.find(f => f.id === fieldId);
            if (!field) return;
            field.value = value;
            saveData();
        }
        function updateCustomFieldMulti(fieldId, selectEl) {
            const values = Array.from(selectEl.selectedOptions).map(o => o.value);
            updateCustomFieldValue(fieldId, values);
        }
        function deleteCustomField(fieldId) {
            const task = tasks.find(t => t.id === activeTaskDetailId);
            if (!task || !task.customFields) return;
            task.customFields = task.customFields.filter(f => f.id !== fieldId);
            saveData();
            renderCustomFields(activeTaskDetailId);
        }
        function renderCustomFields(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const container = document.getElementById('custom-field-list');
            if (!container || !task) return;
            container.innerHTML = '';
            const fields = task.customFields || [];
            if (fields.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500">추가된 커스텀 필드가 없습니다.</div>';
                return;
            }
            fields.forEach(field => {
                const row = document.createElement('div');
                row.className = 'bg-[#0f172a]/50 border border-gray-700/50 rounded p-2';
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-2';
                header.innerHTML = `<span class="text-xs text-gray-400">${field.label}</span><button onclick="deleteCustomField('${field.id}')" class="text-xs text-gray-500 hover:text-red-400">삭제</button>`;
                row.appendChild(header);

                let inputEl = '';
                if (field.type === 'text') {
                    inputEl = `<input type="text" value="${field.value || ''}" oninput="updateCustomFieldValue('${field.id}', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200">`;
                } else if (field.type === 'number') {
                    inputEl = `<input type="number" value="${field.value || ''}" oninput="updateCustomFieldValue('${field.id}', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200">`;
                } else if (field.type === 'date') {
                    inputEl = `<input type="date" value="${field.value || ''}" onchange="updateCustomFieldValue('${field.id}', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200 dark-date-input">`;
                } else if (field.type === 'time') {
                    inputEl = `<input type="time" value="${field.value || ''}" onchange="updateCustomFieldValue('${field.id}', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200">`;
                } else if (field.type === 'boolean') {
                    const checked = field.value ? 'checked' : '';
                    inputEl = `<label class="flex items-center gap-2 text-xs text-gray-300"><input type="checkbox" ${checked} onchange="updateCustomFieldValue('${field.id}', this.checked)" class="rounded bg-[#0f172a] border-gray-600 text-indigo-600">활성</label>`;
                } else if (field.type === 'single') {
                    const options = (field.options || []).map(opt => `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    inputEl = `<select onchange="updateCustomFieldValue('${field.id}', this.value)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200"><option value="">선택</option>${options}</select>`;
                } else if (field.type === 'multi') {
                    const options = (field.options || []).map(opt => `<option value="${opt}" ${(field.value || []).includes(opt) ? 'selected' : ''}>${opt}</option>`).join('');
                    inputEl = `<select multiple onchange="updateCustomFieldMulti('${field.id}', this)" class="w-full bg-[#0f172a] border border-gray-700 rounded px-2 py-1 text-xs text-gray-200">${options}</select>`;
                }

                row.insertAdjacentHTML('beforeend', inputEl);
                container.appendChild(row);
            });
        }
        function handleSearch() {
            if (activeView === 'board') renderBoard();
            else if (activeView === 'projects') renderAllProjectsView();
            else if (activeView === 'contacts') renderContactsView();
        }
        function openProjectModal(mode) {
             document.getElementById('projectModal').classList.remove('hidden'); const t = document.getElementById('projModalTitle'), b = document.getElementById('projSubmitBtn'), f = document.getElementById('projectForm');
             const datesEl = document.getElementById('projDates');
             const managerSelect = document.getElementById('projManager');
             let options = `<option value="변PD">변PD (기본)</option>`; contacts.forEach(c => { options += `<option value="${c.name}">${c.name} (${c.info||c.company})</option>`; });
             managerSelect.innerHTML = options;

             if(mode === 'edit') {
                 currentEditProjId = activeProjectId; const p = getActiveProject(); t.textContent = '프로젝트 정보 수정'; b.textContent = '수정 완료';
                 document.getElementById('projTitle').value = p.title; document.getElementById('projManager').value = p.manager || '변PD';
                 document.getElementById('clientCompany').value = p.clientCompany; document.getElementById('clientName').value = p.clientName;
                 document.getElementById('clientContact').value = p.clientContact; document.getElementById('projBudget').value = p.budget;
                 document.getElementById('projRevenue').value = p.revenue; document.getElementById('projVat').checked = p.vat || false;
                 document.getElementById('projDeadline').value = p.deadline || '';
                 formatCommaInput(document.getElementById('projBudget'));
                 formatCommaInput(document.getElementById('projRevenue'));
                 const radios = document.getElementsByName('status'); for(const r of radios) { if(r.value === p.status) r.checked = true; }
                 datesEl.innerHTML = `생성일: ${p.createdAt || '-'}  |  최근 수정일: ${p.updatedAt || '-'}`; selectColor(p.color);
             } else {
                 currentEditProjId = null; t.textContent = '새 프로젝트 생성'; b.textContent = '생성하기'; f.reset(); 
                 document.getElementById('projManager').value = '변PD'; document.getElementById('status-plan').checked = true;
                 document.getElementById('projBudget').value = '';
                 document.getElementById('projRevenue').value = '';
                 datesEl.innerHTML = ''; selectColor('indigo');
             }
        }
        function closeProjectModal() { document.getElementById('projectModal').classList.add('hidden'); }
        function selectColor(c) { document.getElementById('projColor').value = c; document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-white')); const s = document.querySelector(`.color-btn[data-color="${c}"]`); if(s) s.classList.add('ring-white'); }
        function handleProjectSubmit(e) {
            e.preventDefault();
            const statusRadios = document.getElementsByName('status'); let selectedStatus = '기획';
            for (const r of statusRadios) { if (r.checked) selectedStatus = r.value; }
            const now = new Date().toLocaleDateString();
            const d = { 
                title: document.getElementById('projTitle').value, manager: document.getElementById('projManager').value, 
                clientCompany: document.getElementById('clientCompany').value, clientName: document.getElementById('clientName').value, 
                clientContact: document.getElementById('clientContact').value, budget: parseMoneyInput(document.getElementById('projBudget').value), 
                revenue: parseMoneyInput(document.getElementById('projRevenue').value), color: document.getElementById('projColor').value, 
                status: selectedStatus, vat: document.getElementById('projVat').checked, deadline: document.getElementById('projDeadline').value, updatedAt: now 
            };
            if (currentEditProjId) { const i = projects.findIndex(p => p.id === currentEditProjId); if (i > -1) { projects[i] = { ...projects[i], ...d }; } } 
            else { const n = { id: 'p' + Date.now(), createdAt: now, ...d }; projects.push(n); switchProject(n.id); }
            saveData(); renderAll(); closeProjectModal();
        }

        // --- Live Clock Logic ---
        function updateClock() {
            const now = new Date();
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            const dayName = days[now.getDay()];
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${year}-${month}-${date}(${dayName}) ${hours}:${minutes}:${seconds}`;
            const el = document.getElementById('live-clock');
            if (el) el.textContent = timeString;
        }

        // Initialize App
        init();
        // Start clock
        setInterval(updateClock, 1000);
        updateClock();

    </script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics-compat.js"></script>
    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyDZ7nWpy6E-daoGf_DjeppdcZEdJStDoQM",
        authDomain: "creait-project-plan.firebaseapp.com",
        projectId: "creait-project-plan",
        storageBucket: "creait-project-plan.firebasestorage.app",
        messagingSenderId: "843527621754",
        appId: "1:843527621754:web:19b2d3085c2443080e3fc3",
        measurementId: "G-M055KHXXE9"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>
</body>
</html>
1
